<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RIKA Care - Real App</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #FAFBFC; }
        .container { max-width: 400px; margin: 50px auto; padding: 20px; }
        .card { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .title { font-size: 28px; font-weight: bold; text-align: center; margin-bottom: 10px; color: #4A90A4; }
        .subtitle { text-align: center; color: #6B6B6B; margin-bottom: 30px; }
        .input { width: 100%; padding: 12px; border: 1px solid #E1E5E9; border-radius: 8px; margin-bottom: 15px; font-size: 16px; }
        .btn { background: #4A90A4; color: white; border: none; border-radius: 8px; padding: 15px; width: 100%; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 10px; }
        .btn:hover { background: #3A7A94; }
        .btn-secondary { background: #6B6B6B; }
        .error { background: #FFE6E6; color: #D63031; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; }
        .success { background: #E6F7E6; color: #00B894; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; }
        .hidden { display: none; }
        .dashboard { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .user-info { text-align: center; margin-bottom: 20px; }
        .avatar { width: 60px; height: 60px; background: #4A90A4; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold; margin: 0 auto 10px; }
        .stats { display: flex; justify-content: space-around; margin: 20px 0; }
        .stat { text-align: center; }
        .stat-number { font-size: 20px; font-weight: bold; color: #4A90A4; }
        .stat-label { font-size: 12px; color: #6B6B6B; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login/Register Screen -->
        <div id="authScreen">
            <div class="card">
                <div class="title">üåø RIKA Care</div>
                <div class="subtitle">Your natural beauty journey</div>
                
                <div style="margin-bottom: 15px;">
                    <select id="loginLanguageSelect" onchange="changeLoginLanguage()" style="width: 100%; padding: 8px; border: 1px solid #E1E5E9; border-radius: 6px;">
                        <option value="en">üá∫üá∏ English</option>
                        <option value="es">üá™üá∏ Espa√±ol</option>
                        <option value="fr">üá´üá∑ Fran√ßais</option>
                    </select>
                </div>
                
                <div id="errorMessage" class="error hidden"></div>
                <div id="successMessage" class="success hidden"></div>
                
                <form id="authForm">
                    <input type="email" id="email" class="input" placeholder="Email" required>
                    <input type="password" id="password" class="input" placeholder="Password" required>
                    <button type="submit" class="btn" id="authBtn">Login</button>
                </form>
                
                <button class="btn btn-secondary" onclick="toggleAuthMode()">Don't have an account? Sign up</button>
            </div>
        </div>

        <!-- Dashboard Screen -->
        <div id="dashboardScreen" class="hidden">
            <div id="dashboardError" class="error hidden"></div>
            <div id="dashboardSuccess" class="success hidden"></div>
            
            <div class="dashboard">
                <div class="user-info">
                    <div class="avatar" id="userAvatar">U</div>
                    <div id="userName">User</div>
                    <div style="font-size: 12px; color: #6B6B6B;" id="userEmail">user@email.com</div>
                </div>
                
                <div class="stats">
                    <div class="stat">
                        <div class="stat-number" id="followersCount">0</div>
                        <div class="stat-label">Followers</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number" id="followingCount">0</div>
                        <div class="stat-label">Following</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number" id="verificationStatus">‚ùå</div>
                        <div class="stat-label">Verified</div>
                    </div>
                </div>
                
                <div id="influencerInfo" class="hidden" style="background: #F4E4C1; padding: 15px; border-radius: 8px; text-align: center; margin: 15px 0;">
                    <div style="font-weight: bold; margin-bottom: 5px;">üèÜ Influencer Status</div>
                    <div id="influencerTier">Bronze Tier</div>
                    <div style="font-size: 12px; color: #6B6B6B; margin-top: 5px;">Commission: <span id="commissionRate">8%</span></div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Language / Idioma / Langue:</label>
                    <select id="languageSelect" onchange="changeLanguage()" style="width: 100%; padding: 8px; border: 1px solid #E1E5E9; border-radius: 6px;">
                        <option value="en">üá∫üá∏ English</option>
                        <option value="es">üá™üá∏ Espa√±ol</option>
                        <option value="fr">üá´üá∑ Fran√ßais</option>
                    </select>
                </div>
                
                <button class="btn" onclick="verifyEmail()" id="verifyBtn">Verify Email</button>
                <button class="btn" onclick="showRecommendations()">Get Recommendations</button>
                <button class="btn" onclick="showCommunity()">View Community</button>
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        let authToken = localStorage.getItem('rikaToken');
        let isLoginMode = true;

        // Load saved language
        const savedLanguage = localStorage.getItem('rika-language') || 'en';
        document.getElementById('loginLanguageSelect').value = savedLanguage;
        
        // Check if user is already logged in
        if (authToken) {
            showDashboard();
        }

        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const endpoint = isLoginMode ? '/auth/login' : '/auth/register';
                const body = isLoginMode ? 
                    { email, password } : 
                    { email, password, profile: { personalInfo: { name: email.split('@')[0] } } };
                
                const response = await fetch(API_BASE + endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    authToken = data.token;
                    localStorage.setItem('rikaToken', authToken);
                    showSuccess(isLoginMode ? 'Login successful!' : 'Account created successfully!');
                    setTimeout(showDashboard, 1000);
                } else {
                    showError(data.error || 'Authentication failed');
                }
            } catch (error) {
                showError('Connection error. Make sure your backend server is running on port 3000.');
            }
        });

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            const authBtn = document.getElementById('authBtn');
            const toggleBtn = document.querySelector('.btn-secondary');
            
            if (isLoginMode) {
                authBtn.textContent = 'Login';
                toggleBtn.textContent = "Don't have an account? Sign up";
            } else {
                authBtn.textContent = 'Sign Up';
                toggleBtn.textContent = 'Already have an account? Login';
            }
        }

        async function showDashboard() {
            try {
                const response = await fetch(API_BASE + '/user/profile', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const user = await response.json();
                    
                    document.getElementById('authScreen').classList.add('hidden');
                    document.getElementById('dashboardScreen').classList.remove('hidden');
                    
                    // Update user info
                    const name = user.profile?.personalInfo?.name || user.email.split('@')[0].replace(/[._]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    document.getElementById('userName').textContent = `Hello, ${name}!`;
                    document.getElementById('userEmail').textContent = user.email;
                    document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
                    
                    // Load user language preference
                    loadUserLanguage();
                    
                    // Update stats
                    document.getElementById('followersCount').textContent = (user.followers || []).length;
                    document.getElementById('followingCount').textContent = (user.following || []).length;
                    document.getElementById('verificationStatus').textContent = 
                        user.verification?.status === 'verified' ? '‚úÖ' : '‚ùå';
                    
                    // Show influencer info if applicable
                    if (user.influencer_status?.status) {
                        document.getElementById('influencerInfo').classList.remove('hidden');
                        document.getElementById('influencerTier').textContent = 
                            (user.influencer_status.tier || 'bronze').charAt(0).toUpperCase() + 
                            (user.influencer_status.tier || 'bronze').slice(1) + ' Tier';
                        document.getElementById('commissionRate').textContent = 
                            Math.round((user.influencer_status.commission || 0.08) * 100) + '%';
                    }
                } else {
                    logout();
                }
            } catch (error) {
                showError('Failed to load user data');
            }
        }

        async function testAPI() {
            alert('Button clicked! Testing API...');
            try {
                console.log('Testing API connection to:', API_BASE + '/health');
                const response = await fetch(API_BASE + '/health');
                console.log('Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Response data:', data);
                    alert(`‚úÖ API Connected! Server status: ${data.status}`);
                } else {
                    console.log('Response not OK:', response.status, response.statusText);
                    alert(`API Error: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                console.error('API Test Error:', error);
                alert(`Connection failed: ${error.message}`);
            }
        }

        function logout() {
            localStorage.removeItem('rikaToken');
            authToken = null;
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('dashboardScreen').classList.add('hidden');
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
        }

        async function showRecommendations() {
            try {
                const response = await fetch(API_BASE + '/recommendations', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(`üåø Your Recommendations:\n\n${data.products?.slice(0,3).map(p => `‚Ä¢ ${p.name} (${p.matchPercentage}% match)`).join('\n') || 'Complete your profile for personalized recommendations!'}`);
                } else {
                    alert('Please complete your profile setup first');
                }
            } catch (error) {
                alert('Recommendations not available yet');
            }
        }
        
        async function showCommunity() {
            try {
                const response = await fetch(API_BASE + '/community/feed', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const posts = await response.json();
                    const communityText = posts.length > 0 ? 
                        posts.slice(0,3).map(p => `‚Ä¢ ${p.user_profile?.personalInfo?.name || 'User'}: ${p.title || p.content?.substring(0,50)}...`).join('\n') :
                        'No posts yet. Be the first to share your beauty journey!';
                    alert(`üë• Community Feed:\n\n${communityText}`);
                } else {
                    alert('Community feed not available');
                }
            } catch (error) {
                alert('üë• Community coming soon! Connect with other beauty enthusiasts.');
            }
        }
        
        async function verifyEmail() {
            try {
                const response = await fetch(API_BASE + '/user/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        method: 'email',
                        data: { email: document.getElementById('userEmail').textContent }
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showSuccess('‚úÖ Email verified successfully!');
                    document.getElementById('verificationStatus').textContent = '‚úÖ';
                    document.getElementById('verifyBtn').textContent = 'Verified!';
                    document.getElementById('verifyBtn').style.background = '#52A788';
                } else {
                    showError(data.error || 'Verification failed');
                }
            } catch (error) {
                showError('Verification request failed');
            }
        }
        
        function showError(message) {
            console.log('Showing error:', message);
            let errorEl = document.getElementById('errorMessage') || document.getElementById('dashboardError');
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
                setTimeout(() => errorEl.classList.add('hidden'), 5000);
            } else {
                alert('Error: ' + message);
            }
        }

        function showSuccess(message) {
            console.log('Showing success:', message);
            let successEl = document.getElementById('successMessage') || document.getElementById('dashboardSuccess');
            if (successEl) {
                successEl.textContent = message;
                successEl.classList.remove('hidden');
                setTimeout(() => successEl.classList.add('hidden'), 3000);
            } else {
                alert('Success: ' + message);
            }
        }
        
        async function loadUserLanguage() {
            try {
                const response = await fetch(API_BASE + '/user/language', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('languageSelect').value = data.language;
                }
            } catch (error) {
                console.log('Could not load language preference');
            }
        }
        
        function changeLoginLanguage() {
            const selectedLanguage = document.getElementById('loginLanguageSelect').value;
            localStorage.setItem('rika-language', selectedLanguage);
        }
        
        async function changeLanguage() {
            const selectedLanguage = document.getElementById('languageSelect').value;
            
            try {
                const response = await fetch(API_BASE + '/user/language', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ language: selectedLanguage })
                });
                
                if (response.ok) {
                    showSuccess('Language updated successfully!');
                    // Here you would typically reload the UI with new language
                    // For now, we'll just show a success message
                } else {
                    showError('Failed to update language');
                }
            } catch (error) {
                showError('Language update failed');
            }
        }
    </script>
</body>
</html>