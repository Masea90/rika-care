<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>RIKA Care - Real beauty. Real guidance.</title>
    <!-- PWA Configuration -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#C4A484">

    <!-- iOS PWA Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="RIKA Care">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.svg">
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-192x192.svg">

    <!-- Android PWA Support -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/icons/icon-72x72.svg">

    <!-- SEO & Social -->
    <meta name="description" content="Your personal AI-powered beauty companion for natural skincare and haircare recommendations">
    <meta name="keywords" content="skincare, haircare, natural beauty, AI recommendations, RIKA Care">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="RIKA Care - Real beauty. Real guidance.">
    <meta property="og:description" content="Your personal AI-powered beauty companion for natural skincare and haircare">
    <meta property="og:image" content="/icons/icon-512x512.svg">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="RIKA Care - Real beauty. Real guidance.">
    <meta name="twitter:description" content="Your personal AI-powered beauty companion">
    <meta name="twitter:image" content="/icons/icon-512x512.svg">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #FEFCFA;
            color: #2C2C2C;
            line-height: 1.5;
        }
        
        .phone-frame {
            max-width: 100%;
            margin: 0;
            background: #FEFCFA;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            min-height: 100vh;
            position: relative;
            border: none;
        }
        
        @media (min-width: 768px) {
            .phone-frame {
                max-width: 375px;
                margin: 20px auto;
                border-radius: 30px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.08);
                min-height: 667px;
                border: 1px solid #F0EBE6;
            }
        }
        
        .screen { display: none; padding: 24px; min-height: 627px; padding-bottom: 90px; }
        .screen.active { display: block; }
        
        .header {
            text-align: center;
            margin-bottom: 32px;
            padding: 16px 0;
        }
        
        .logo {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #E8DDD4, #D4C4B0);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 300;
            color: #6B5B73;
            margin: 0 auto 16px;
            letter-spacing: -1px;
        }
        
        .title { font-size: 28px; font-weight: 300; color: #2C2C2C; margin-bottom: 8px; letter-spacing: -0.5px; }
        .subtitle { font-size: 16px; color: #8B7D7D; font-weight: 300; }
        .tagline { font-size: 14px; color: #A69B9B; margin-top: 8px; }
        
        .card {
            background: #FFFFFF;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            border: 1px solid #F5F0EB;
            box-shadow: 0 2px 12px rgba(0,0,0,0.04);
            opacity: 0;
            transform: translateY(10px);
            animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        .card:nth-child(2) { animation-delay: 0.1s; }
        .card:nth-child(3) { animation-delay: 0.2s; }
        .card:nth-child(4) { animation-delay: 0.3s; }
        
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .card-title { font-size: 18px; font-weight: 400; margin-bottom: 16px; color: #2C2C2C; }
        
        .positive-card {
            background: linear-gradient(135deg, #F8F6F3, #F5F2EF);
            border: 1px solid #E8DDD4;
        }
        
        .skin-mood {
            font-size: 13px;
            color: #8B7D7D;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #F5F0EB;
            font-weight: 300;
        }
        
        .input {
            width: 100%;
            padding: 16px;
            border: 1px solid #E8DDD4;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 16px;
            background: #FEFCFA;
            color: #2C2C2C;
        }

        .input:focus { outline: none; border-color: #C4A484; }

        .password-wrapper {
            position: relative;
            width: 100%;
            margin-bottom: 16px;
        }

        .password-wrapper .input {
            margin-bottom: 0;
            padding-right: 48px;
        }

        .password-toggle {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            font-size: 20px;
            user-select: none;
            z-index: 10;
        }
        
        .btn {
            background: linear-gradient(135deg, #C4A484, #B8A082);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 24px;
            font-size: 16px;
            font-weight: 400;
            cursor: pointer;
            width: 100%;
            margin-top: 16px;
            letter-spacing: 0.3px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn:hover { opacity: 0.9; }
        
        .btn-shimmer {
            position: relative;
            overflow: hidden;
        }
        
        .btn-shimmer::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        .btn-secondary { background: #F5F0EB; color: #6B5B73; }
        .btn-ghost { background: transparent; border: 1px solid #E8DDD4; color: #6B5B73; }
        
        .privacy-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 16px 0;
        }
        
        .privacy-option {
            background: #F9F6F3;
            border: 1px solid #E8DDD4;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            color: #6B5B73;
        }
        
        .privacy-option.selected {
            background: #E8DDD4;
            border-color: #C4A484;
            color: #2C2C2C;
        }
        
        .scan-interface {
            position: relative;
            width: 280px;
            height: 280px;
            margin: 40px auto;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(196,164,132,0.1) 0%, rgba(196,164,132,0.05) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .scan-ring {
            position: absolute;
            border: 2px solid #C4A484;
            border-radius: 50%;
            opacity: 0.6;
            animation: pulse 2s infinite;
        }
        
        .scan-ring:nth-child(1) { width: 200px; height: 200px; }
        .scan-ring:nth-child(2) { width: 240px; height: 240px; animation-delay: 0.5s; }
        .scan-ring:nth-child(3) { width: 280px; height: 280px; animation-delay: 1s; }
        
        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 0.8; }
            50% { transform: scale(1); opacity: 0.4; }
            100% { transform: scale(1.1); opacity: 0.1; }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .face-outline {
            width: 160px;
            height: 200px;
            border: 2px solid #C4A484;
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            opacity: 0.7;
        }
        
        .skin-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 24px 0;
        }
        
        .metric {
            background: #F9F6F3;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }
        
        .metric-value { font-size: 20px; font-weight: 400; color: #C4A484; margin-bottom: 4px; }
        .metric-label { font-size: 12px; color: #8B7D7D; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .ingredient-card {
            background: #FFFFFF;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 12px;
            border: 1px solid #F5F0EB;
        }
        
        .ingredient-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .match-score {
            background: #E8F5E8;
            color: #4A7C59;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .ingredients-list {
            font-size: 14px;
            color: #6B5B73;
            margin-bottom: 8px;
        }
        
        .red-flags {
            background: #FFF5F5;
            border: 1px solid #FECACA;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }
        
        .red-flags-title {
            font-size: 12px;
            color: #DC2626;
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .nav-tabs {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid #F5F0EB;
            display: none; /* Hidden by default until authenticated */
            z-index: 100;
            padding: 8px 0;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        @media (min-width: 768px) {
            .nav-tabs {
                left: 50%;
                transform: translateX(-50%);
                width: 375px;
                padding-bottom: 8px;
            }
        }
        
        .nav-tab {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 10px;
            color: #A69B9B;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-weight: 400;
            letter-spacing: 0.3px;
        }
        
        .nav-tab.active { color: #C4A484; }
        .nav-icon { font-size: 20px; margin-bottom: 4px; }
        
        .verified-badge {
            background: #E8F5E8;
            color: #4A7C59;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 500;
            margin-left: 8px;
        }
        
        .routine-item {
            background: #F9F6F3;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .routine-item.completed {
            background: #E8F5E8;
            border: 1px solid #C6F6D5;
        }
        
        .checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #E8DDD4;
            border-radius: 50%;
            margin-right: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .checkbox.checked {
            background: #4A7C59;
            border-color: #4A7C59;
            color: white;
        }
        
        .progress-ring {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: conic-gradient(#D4A574 0deg 234deg, #F5F0EB 234deg 360deg);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            position: relative;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .progress-ring.animate {
            animation: progressFill 1.2s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        @keyframes progressFill {
            from { background: conic-gradient(#D4A574 0deg 0deg, #F5F0EB 0deg 360deg); }
            to { background: conic-gradient(#D4A574 0deg 234deg, #F5F0EB 234deg 360deg); }
        }
        
        .progress-inner {
            width: 60px;
            height: 60px;
            background: #FEFCFA;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .progress-text { font-size: 16px; font-weight: 400; color: #C4A484; }
        .progress-label { font-size: 10px; color: #8B7D7D; }
        
        .community-post {
            background: #FFFFFF;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid #F5F0EB;
        }
        
        .post-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #E8DDD4, #D4C4B0);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6B5B73;
            font-weight: 400;
            margin-right: 12px;
        }
        
        .post-content {
            font-size: 15px;
            color: #2C2C2C;
            line-height: 1.5;
            margin-bottom: 16px;
        }
        
        .post-actions {
            display: flex;
            justify-content: space-between;
            padding-top: 12px;
            border-top: 1px solid #F5F0EB;
        }
        
        .action-btn {
            background: none;
            border: none;
            color: #A69B9B;
            cursor: pointer;
            font-size: 13px;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .action-btn:hover { background: #F9F6F3; }
        
        .skin-report {
            background: linear-gradient(135deg, #F9F6F3, #F5F0EB);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .report-title {
            font-size: 20px;
            font-weight: 400;
            color: #2C2C2C;
            margin-bottom: 16px;
        }
        
        .hidden { display: none !important; }
        .error { background: #FFF5F5; color: #DC2626; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; }
        .success { background: #F0FDF4; color: #166534; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; }
    </style>
</head>
<body>
    <div class="phone-frame">
        <!-- Auth Screen -->
        <div class="screen active" id="auth">
            <div class="header">
                <div class="logo">RC</div>
                <div class="title">Welcome to RIKA Care</div>
                <div class="subtitle">Real beauty. Real guidance.</div>
                <div class="tagline">AI-powered skincare for authentic results</div>
            </div>
            
            <div style="margin-bottom: 16px;">
                <select id="loginLanguageSelect" onchange="changeLoginLanguage()" style="width: 100%; padding: 12px; border: 1px solid #E8DDD4; border-radius: 12px; font-size: 14px; background: #FEFCFA; color: #2C2C2C;">
                    <option value="en">üá∫üá∏ English</option>
                    <option value="es">üá™üá∏ Espa√±ol</option>
                    <option value="fr">üá´üá∑ Fran√ßais</option>
                </select>
            </div>
            
            <div id="authError" class="error hidden"></div>
            
            <!-- Sign Up Form -->
            <div class="card" id="signupForm">
                <div class="card-title">Create Account</div>
                <input type="email" id="signupEmail" class="input" placeholder="Email address" required>
                <div class="password-wrapper">
                    <input type="password" id="signupPassword" class="input" placeholder="Create password" required>
                    <span class="password-toggle" onclick="togglePasswordVisibility('signupPassword', this)">üëÅÔ∏è</span>
                </div>
                <input type="text" id="signupName" class="input" placeholder="Display name" required>

                <button class="btn" onclick="signup()">Create Account</button>

                <!-- Divider -->
                <div style="display: flex; align-items: center; margin: 20px 0; gap: 12px;">
                    <div style="flex: 1; height: 1px; background: #E8DDD4;"></div>
                    <div style="font-size: 13px; color: #A89BA0;">or</div>
                    <div style="flex: 1; height: 1px; background: #E8DDD4;"></div>
                </div>

                <!-- Google Sign-In Button -->
                <button class="btn" onclick="signInWithGoogle()" style="background: white; color: #2C2C2C; border: 1px solid #E8DDD4; display: flex; align-items: center; justify-content: center; gap: 12px;">
                    <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z" fill="#4285F4"/>
                        <path d="M9.003 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.96v2.332C2.44 15.983 5.485 18 9.003 18z" fill="#34A853"/>
                        <path d="M3.964 10.712c-.18-.54-.282-1.117-.282-1.71 0-.593.102-1.17.282-1.71V4.96H.957C.347 6.175 0 7.55 0 9.002c0 1.452.348 2.827.957 4.042l3.007-2.332z" fill="#FBBC05"/>
                        <path d="M9.003 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.464.891 11.426 0 9.003 0 5.485 0 2.44 2.017.96 4.958L3.967 7.29c.708-2.127 2.692-3.71 5.036-3.71z" fill="#EA4335"/>
                    </svg>
                    Sign in with Google
                </button>

                <button class="btn-ghost btn" onclick="showLoginForm()">Already have an account? Log in</button>
            </div>

            <!-- Log In Form -->
            <div class="card hidden" id="loginForm">
                <div class="card-title">Log In</div>
                <input type="email" id="loginEmail" class="input" placeholder="Email address" required>
                <div class="password-wrapper">
                    <input type="password" id="loginPassword" class="input" placeholder="Password" required>
                    <span class="password-toggle" onclick="togglePasswordVisibility('loginPassword', this)">üëÅÔ∏è</span>
                </div>

                <button class="btn" onclick="login()">Log In</button>

                <!-- Divider -->
                <div style="display: flex; align-items: center; margin: 20px 0; gap: 12px;">
                    <div style="flex: 1; height: 1px; background: #E8DDD4;"></div>
                    <div style="font-size: 13px; color: #A89BA0;">or</div>
                    <div style="flex: 1; height: 1px; background: #E8DDD4;"></div>
                </div>

                <!-- Google Sign-In Button -->
                <button class="btn" onclick="signInWithGoogle()" style="background: white; color: #2C2C2C; border: 1px solid #E8DDD4; display: flex; align-items: center; justify-content: center; gap: 12px;">
                    <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z" fill="#4285F4"/>
                        <path d="M9.003 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.96v2.332C2.44 15.983 5.485 18 9.003 18z" fill="#34A853"/>
                        <path d="M3.964 10.712c-.18-.54-.282-1.117-.282-1.71 0-.593.102-1.17.282-1.71V4.96H.957C.347 6.175 0 7.55 0 9.002c0 1.452.348 2.827.957 4.042l3.007-2.332z" fill="#FBBC05"/>
                        <path d="M9.003 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.464.891 11.426 0 9.003 0 5.485 0 2.44 2.017.96 4.958L3.967 7.29c.708-2.127 2.692-3.71 5.036-3.71z" fill="#EA4335"/>
                    </svg>
                    Sign in with Google
                </button>

                <button class="btn-ghost btn" onclick="showSignupForm()">Need an account? Sign up</button>
            </div>
        </div>

        <!-- Privacy First Screen -->
        <div class="screen" id="privacyFirst">
            <div class="header">
                <div class="logo">R</div>
                <div class="title">Privacy First</div>
                <div class="subtitle">Choose your visibility</div>
                <div class="tagline">You can change this anytime in settings</div>
            </div>
            
            <div class="card">
                <div class="card-title">Who can see your content?</div>
                <div style="font-size: 14px; color: #6B5B73; margin-bottom: 20px;">
                    Choose who can see your content and interact with you.
                </div>
                
                <div class="privacy-selector">
                    <div class="privacy-option selected" onclick="selectPrivacy(this, 'women')">
                        <div style="font-size: 16px; margin-bottom: 4px;">üë©</div>
                        <div>Women</div>
                    </div>
                    <div class="privacy-option" onclick="selectPrivacy(this, 'men')">
                        <div style="font-size: 16px; margin-bottom: 4px;">üë®</div>
                        <div>Men</div>
                    </div>
                    <div class="privacy-option" onclick="selectPrivacy(this, 'everyone')">
                        <div style="font-size: 16px; margin-bottom: 4px;">üë•</div>
                        <div>Everyone</div>
                    </div>
                    <div class="privacy-option" onclick="selectPrivacy(this, 'private')">
                        <div style="font-size: 16px; margin-bottom: 4px;">üîí</div>
                        <div>Only Me</div>
                    </div>
                </div>
                
                <button class="btn" onclick="saveVisibilityAndContinue()">Continue</button>
            </div>
        </div>

        <!-- Skin Quiz -->
        <div class="screen" id="skinQuiz">
            <div class="header">
                <div class="title">Know Your Skin</div>
                <div class="subtitle">Quick assessment for personalized guidance</div>
            </div>
            
            <div class="card">
                <div class="card-title">What's your primary skin concern?</div>
                <div class="privacy-selector" style="grid-template-columns: 1fr;">
                    <div class="privacy-option" onclick="selectConcern(this, 'dryness')">Dryness & Dehydration</div>
                    <div class="privacy-option" onclick="selectConcern(this, 'acne')">Acne & Breakouts</div>
                    <div class="privacy-option" onclick="selectConcern(this, 'aging')">Fine Lines & Aging</div>
                    <div class="privacy-option" onclick="selectConcern(this, 'sensitivity')">Sensitivity & Redness</div>
                    <div class="privacy-option" onclick="selectConcern(this, 'dullness')">Dullness & Uneven Tone</div>
                </div>
            </div>
            
            <button class="btn" onclick="showScreen('aiScan')" id="continueQuiz" disabled>Continue to AI Scan</button>
            <button class="btn-ghost btn" onclick="showScreen('dashboard')">Skip Scan for Now</button>
        </div>

        <!-- AI Skin Scan -->
        <div class="screen" id="aiScan">
            <div class="header">
                <div class="title">Skin Analysis Quiz</div>
                <div class="subtitle">Personalized recommendations based on your input</div>
            </div>

            <div style="background: #FFF9F5; padding: 16px; border-radius: 12px; margin-bottom: 24px; border-left: 4px solid #C4A484;">
                <div style="font-size: 13px; color: #6B5B73; line-height: 1.6;">
                    <strong>Note:</strong> This is a demonstration feature. The analysis is based on your quiz answers and provides general skincare guidance. For personalized medical advice, please consult a dermatologist.
                </div>
            </div>

            <div class="scan-interface">
                <div class="scan-ring"></div>
                <div class="scan-ring"></div>
                <div class="scan-ring"></div>
                <div class="face-outline"></div>
            </div>

            <div style="text-align: center; margin-bottom: 24px;">
                <div style="font-size: 16px; color: #6B5B73; margin-bottom: 8px;">Position your face in the outline</div>
                <div style="font-size: 14px; color: #A69B9B;">Clean face, natural lighting, remove glasses</div>
            </div>

            <button class="btn" onclick="startScan()">Start Analysis</button>
        </div>

        <!-- Camera Modal -->
        <div id="cameraModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 9999; overflow: auto;">
            <div style="max-width: 600px; margin: 0 auto; padding: 20px; position: relative;">
                <!-- Close Button -->
                <button onclick="closeCameraModal()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 24px; cursor: pointer; z-index: 10000;">√ó</button>

                <!-- Camera View -->
                <div id="cameraView" style="text-align: center;">
                    <h2 style="color: white; margin-bottom: 20px;">Position Your Face</h2>
                    <div style="background: #FFF9F5; padding: 12px; border-radius: 8px; margin-bottom: 20px;">
                        <p style="color: #6B5B73; font-size: 14px; margin: 0;">
                            üì∏ Clean face ‚Ä¢ Natural lighting ‚Ä¢ Remove glasses
                        </p>
                    </div>

                    <!-- Video Preview -->
                    <div style="position: relative; max-width: 100%; margin: 0 auto;">
                        <video id="cameraVideo" autoplay playsinline style="width: 100%; max-width: 400px; border-radius: 12px; transform: scaleX(-1);"></video>
                        <canvas id="cameraCanvas" style="display: none;"></canvas>

                        <!-- Face Outline Overlay -->
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 200px; height: 260px; border: 3px dashed #C4A484; border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%; opacity: 0.7; pointer-events: none;"></div>
                    </div>

                    <!-- Loading State -->
                    <div id="cameraLoading" style="display: none; color: white; margin: 20px 0;">
                        <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid rgba(196,164,132,0.3); border-top-color: #C4A484; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <p style="margin-top: 10px;">Accessing camera...</p>
                    </div>

                    <!-- Error State -->
                    <div id="cameraError" style="display: none; color: #ff6b6b; background: rgba(255,107,107,0.1); padding: 16px; border-radius: 8px; margin: 20px 0;">
                        <p style="margin: 0; font-size: 14px;"></p>
                    </div>

                    <!-- Capture Button -->
                    <button id="captureBtn" class="btn" onclick="captureImage()" style="margin-top: 20px; display: none; background: #C4A484;">
                        üì∑ Capture Image
                    </button>
                </div>

                <!-- Preview View (After Capture) -->
                <div id="previewView" style="display: none; text-align: center;">
                    <h2 style="color: white; margin-bottom: 20px;">Image Captured!</h2>
                    <img id="capturedImage" style="max-width: 100%; border-radius: 12px; margin-bottom: 20px;" />

                    <!-- Analysis Status -->
                    <div id="analysisStatus" style="background: #FFF9F5; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <div id="analysisLoading" style="display: none;">
                            <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid rgba(196,164,132,0.3); border-top-color: #C4A484; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            <p style="color: #6B5B73; margin-top: 10px;">Analyzing your skin...</p>
                        </div>
                        <div id="analysisResult" style="display: none;">
                            <p style="color: #6B5B73; font-size: 16px; margin: 0;">
                                ‚ú® <strong>Analysis Complete!</strong><br>
                                <span style="font-size: 14px;">AI skin analysis coming soon</span>
                            </p>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <button class="btn-ghost btn" onclick="retakePhoto()" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3);">
                            üîÑ Retake
                        </button>
                        <button class="btn" onclick="finishCapture()" style="background: #C4A484;">
                            Continue
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Skin Report -->
        <div class="screen" id="skinReport">
            <div class="header">
                <div class="title">Your Skin Report</div>
            </div>

            <div class="skin-report">
                <div class="report-title">Analysis Complete</div>
                <div style="font-size: 14px; color: #6B5B73; margin-bottom: 20px;">
                    Based on AI analysis of your skin
                </div>

                <div class="skin-metrics">
                    <div class="metric">
                        <div class="metric-value">72%</div>
                        <div class="metric-label">Hydration</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">Medium</div>
                        <div class="metric-label">Oil Zones</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">Low</div>
                        <div class="metric-label">Redness</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">Fine</div>
                        <div class="metric-label">Pore Size</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">Key Recommendations</div>
                <div style="font-size: 14px; color: #6B5B73; line-height: 1.6;">
                    ‚Ä¢ Focus on hydrating ingredients like hyaluronic acid<br>
                    ‚Ä¢ Use gentle, non-comedogenic products<br>
                    ‚Ä¢ Avoid alcohol-based toners<br>
                    ‚Ä¢ SPF 30+ daily protection essential
                </div>
            </div>

            <button class="btn" onclick="showScreen('dashboard')">Go to Dashboard</button>
        </div>

        <!-- Beauty Profile Setup -->
        <div class="screen" id="beautyProfile">
            <div class="header">
                <div class="title">Complete Your Profile</div>
                <div class="subtitle">Help us personalize your experience</div>
            </div>
            
            <div class="card">
                <div class="card-title">Tell us about yourself</div>
                <div style="background: #F9F6F3; padding: 16px; border-radius: 12px; margin: 16px 0;">
                    <div style="font-size: 12px; color: #6B5B73; margin-bottom: 8px;">
                        <strong>Optional but Recommended</strong>
                    </div>
                    <div style="font-size: 12px; color: #8B7D7D;">
                        This helps us provide better recommendations and connect you with similar users.
                    </div>
                </div>
                
                <button class="btn" onclick="showScreen('skinQuiz')">Continue to Skin Quiz</button>
                <button class="btn-ghost btn" onclick="showScreen('dashboard')">Skip for Now</button>
            </div>
        </div>

        <!-- Dashboard -->
        <div class="screen" id="dashboard">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 32px; padding: 16px 0;">
                <div class="logo" style="width: 32px; height: 32px; font-size: 16px; margin: 0; color: #B8A082; opacity: 0.7;">RC</div>
                <div style="text-align: center; flex: 1;">
                    <div class="title" style="font-size: 24px; margin-bottom: 4px;" id="personalGreeting">Good evening, User üåø</div>
                    <div style="font-size: 13px; color: #A69B9B; font-weight: 200; letter-spacing: 0.3px;">Your natural beauty dashboard</div>
                </div>
                <div id="pointsBadge" style="background: linear-gradient(135deg, #E8DDD4, #D4C4B0); color: #6B5B73; padding: 8px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; cursor: pointer;" onclick="openRewardsStore()">‚≠ê 0 points</div>
            </div>
            
            <!-- Natural Glow Score -->
            <div class="card" style="background: linear-gradient(135deg, #F9F6F3, #F5F2EF); box-shadow: 0 1px 8px rgba(0,0,0,0.02); margin-bottom: 20px; text-align: center;">
                <div class="card-title" style="color: #6B5B73; margin-bottom: 16px;">üåü Your Natural Glow Score</div>
                <div style="font-size: 32px; font-weight: 300; color: #C4A484; margin-bottom: 8px;">87/100</div>
                <div style="font-size: 13px; color: #8B7D7D; margin-bottom: 16px;">This week's wellness journey</div>
                <div style="display: flex; justify-content: space-between; font-size: 12px; color: #A69B9B;">
                    <div>Skin: 92%</div>
                    <div>Hair: 85%</div>
                    <div>Nutrition: 84%</div>
                </div>
            </div>
            
            <!-- Streak Component -->
            <div class="card" style="background: linear-gradient(135deg, #FEF3C7, #FDE68A); box-shadow: 0 1px 8px rgba(0,0,0,0.02); margin-bottom: 16px; text-align: center;">
                <div style="display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 8px;">
                    <div style="font-size: 24px;">üî•</div>
                    <div>
                        <div id="streakDisplay" style="font-size: 18px; font-weight: 500; color: #92400E;">Start your streak today ‚ú®</div>
                        <div id="streakBest" style="font-size: 12px; color: #B45309; margin-top: 2px;"></div>
                    </div>
                </div>
                <button id="completeRoutineBtn" onclick="completeRoutineDay()" class="btn" style="background: linear-gradient(135deg, #F59E0B, #D97706); font-size: 14px; padding: 10px 16px; margin-top: 8px;">Complete Today's Routine</button>
            </div>
            
            <!-- Your Skin Today -->
            <div class="card" style="box-shadow: 0 1px 8px rgba(0,0,0,0.02); margin-bottom: 16px;">
                <div class="card-title" style="margin-bottom: 16px;">üå∏ Your Skin Today</div>
                <div style="font-size: 14px; color: #6B5B73; margin-bottom: 8px; line-height: 1.5;">
                    Hydration levels look good. Consider a gentle exfoliant this week.
                </div>
                <div class="skin-mood">
                    Skin mood: Balanced üòä
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 12px; font-size: 12px; color: #8B7D7D;">
                    <div>Hydration: 78%</div>
                    <div>Oil zones: T-zone</div>
                    <div>Sensitivity: Low</div>
                </div>
            </div>
            
            <!-- Your Hair Today -->
            <div class="card" style="box-shadow: 0 1px 8px rgba(0,0,0,0.02); margin-bottom: 16px;">
                <div class="card-title" style="margin-bottom: 16px;">üåø Your Hair Today</div>
                <div style="font-size: 14px; color: #6B5B73; margin-bottom: 8px; line-height: 1.5;">
                    Scalp looks healthy. Try rosemary oil for extra shine this week.
                </div>
                <div class="skin-mood">
                    Hair mood: Strong & happy üí™
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 12px; font-size: 12px; color: #8B7D7D;">
                    <div>Scalp: Balanced</div>
                    <div>Frizz risk: Low</div>
                    <div>Damage: Minimal</div>
                </div>
            </div>
            
            <!-- Beauty Nutrition -->
            <div class="card" style="background: linear-gradient(135deg, #F8F6F3, #F5F2EF); box-shadow: 0 1px 8px rgba(0,0,0,0.02); margin-bottom: 16px;">
                <div class="card-title" style="color: #6B5B73; margin-bottom: 16px;">ü•ë Beauty Bite of the Day</div>
                <div style="font-size: 14px; color: #6B5B73; line-height: 1.5; margin-bottom: 12px;">
                    ü•ë Avocados are rich in omega-3s and vitamin E ‚Äî perfect for glowing skin and strong hair!
                </div>
                <div style="font-size: 12px; color: #8B7D7D;">
                    üíß Hydration reminder: You're doing great with 6/8 glasses today
                </div>
            </div>
            
            <!-- Ingredient Alerts -->
            <div class="card" style="box-shadow: 0 1px 8px rgba(0,0,0,0.02); margin-bottom: 16px;">
                <div class="card-title">Ingredient Alerts</div>
                <div style="background: #FDF7F7; padding: 12px; border-radius: 12px; border: 1px solid #F4D4D4; margin-bottom: 8px;">
                    <div style="font-size: 12px; color: #C53030; margin-bottom: 4px;">‚ö†Ô∏è Skin: Avoid fragrance</div>
                </div>
                <div style="background: #FDF7F7; padding: 12px; border-radius: 12px; border: 1px solid #F4D4D4;">
                    <div style="font-size: 12px; color: #C53030;">‚ö†Ô∏è Hair: Avoid sulfates & silicones</div>
                </div>
            </div>
            
            <!-- Rewards Card -->
            <div class="card" style="background: linear-gradient(135deg, #F4E4C1, #F0DDB8); box-shadow: 0 1px 8px rgba(0,0,0,0.02); margin-bottom: 16px; position: relative; overflow: hidden;">
                <div style="position: absolute; top: -10px; right: -10px; font-size: 60px; opacity: 0.1; transform: rotate(15deg);">üéÅ</div>
                <div class="card-title" style="color: #6B5B73; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 20px;">‚≠ê</span>
                    <span>Rewards Store</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div>
                        <div style="font-size: 24px; font-weight: 600; color: #6B5B73;" id="dashboardPoints">0 points</div>
                        <div style="font-size: 12px; color: #8B7D7D;">Ready to redeem</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 11px; color: #8B7D7D; margin-bottom: 4px;">Next reward at:</div>
                        <div style="font-size: 13px; color: #6B5B73; font-weight: 500;" id="nextRewardPoints">100 pts</div>
                    </div>
                </div>
                <div style="background: rgba(255,255,255,0.3); border-radius: 8px; padding: 8px; margin-bottom: 12px; font-size: 11px; color: #6B5B73; text-align: center;">
                    üí∞ Discounts ‚Ä¢ üì¶ Free Samples ‚Ä¢ üë©‚öïÔ∏è Consultations ‚Ä¢ üì± Digital Content
                </div>
                <button class="btn" onclick="openRewardsStore()" style="background: linear-gradient(135deg, #C4A484, #B8A082); font-size: 14px; padding: 12px 20px; position: relative; overflow: hidden;">
                    <span style="position: relative; z-index: 1;">Open Rewards Store</span>
                </button>
            </div>
            
            <!-- Natural Treatment Suggestion -->
            <div class="card positive-card" style="box-shadow: 0 1px 8px rgba(0,0,0,0.02); margin-bottom: 20px;">
                <div class="card-title" style="color: #6B5B73;">üå± Natural Treatment</div>
                <div style="font-size: 14px; color: #6B5B73; line-height: 1.5;">
                    Try a honey & oatmeal mask tonight for gentle exfoliation and hydration.
                </div>
            </div>
            
            <button class="btn btn-shimmer" style="background: linear-gradient(135deg, #D4C4B0, #C4A484); margin-top: 8px; font-size: 15px; padding: 18px 24px; border-radius: 16px; letter-spacing: 0.2px; box-shadow: 0 4px 12px rgba(196,164,132,0.15);">
                View My Routines
            </button>
        </div>

        <!-- Hair Analysis Screen -->
        <div class="screen" id="hairAnalysis">
            <div class="header">
                <div class="title">Hair Analysis</div>
                <div class="subtitle">AI-powered hair & scalp assessment</div>
            </div>
            
            <div class="scan-interface">
                <div class="scan-ring"></div>
                <div class="scan-ring"></div>
                <div class="scan-ring"></div>
                <div style="width: 160px; height: 160px; border: 2px solid #C4A484; border-radius: 50%; opacity: 0.7; display: flex; align-items: center; justify-content: center; font-size: 60px;">üíá‚Äç‚ôÄÔ∏è</div>
            </div>
            
            <div style="text-align: center; margin-bottom: 24px;">
                <div style="font-size: 16px; color: #6B5B73; margin-bottom: 8px;">Position your hair in the frame</div>
                <div style="font-size: 14px; color: #A69B9B;">Clean, dry hair works best for analysis</div>
            </div>
            
            <div class="card">
                <div class="card-title">üìù For Best Results:</div>
                <div style="font-size: 14px; color: #6B5B73; line-height: 1.6;">
                    ‚úì Clean, product-free hair<br>
                    ‚úì Natural lighting<br>
                    ‚úì Show roots and lengths<br>
                    ‚úì Avoid wet or damp hair
                </div>
            </div>
            
            <button class="btn" onclick="startHairScan()">Start Hair Analysis</button>
        </div>

        <!-- Hair Report -->
        <div class="screen" id="hairReport">
            <div class="header">
                <div class="title">Your Hair Report</div>
            </div>
            
            <div class="skin-report">
                <div class="report-title">Analysis Complete</div>
                <div style="font-size: 14px; color: #6B5B73; margin-bottom: 20px;">
                    Based on AI analysis of your hair & scalp
                </div>
                
                <div class="skin-metrics">
                    <div class="metric">
                        <div class="metric-value">Wavy</div>
                        <div class="metric-label">Hair Type</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">Balanced</div>
                        <div class="metric-label">Scalp</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">Low</div>
                        <div class="metric-label">Frizz Risk</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">Minimal</div>
                        <div class="metric-label">Damage</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">Hair Care Recommendations</div>
                <div style="font-size: 14px; color: #6B5B73; line-height: 1.6;">
                    ‚Ä¢ Use sulfate-free shampoos for gentle cleansing<br>
                    ‚Ä¢ Deep condition weekly with natural oils<br>
                    ‚Ä¢ Avoid heat styling when possible<br>
                    ‚Ä¢ Try rice water rinses for strength
                </div>
            </div>
            
            <button class="btn" onclick="showScreen('naturalTreatments')">Explore Natural Treatments</button>
        </div>

        <!-- Natural Treatments -->
        <div class="screen" id="naturalTreatments">
            <div class="header">
                <div class="title">üå± Natural Remedies</div>
                <div class="subtitle">Personalized for your skin & hair</div>
            </div>
            
            <div class="card">
                <div class="card-title">üçØ For Your Skin</div>
                <div class="ingredient-card" style="margin: 0; padding: 16px;">
                    <div style="font-size: 15px; font-weight: 400; margin-bottom: 8px;">Honey & Oatmeal Mask</div>
                    <div style="font-size: 13px; color: #6B5B73; margin-bottom: 8px;">Perfect for sensitive, combination skin</div>
                    <div style="font-size: 12px; color: #8B7D7D;">Mix 2 tbsp oats + 1 tbsp honey. Apply 15 mins.</div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">üåø For Your Hair</div>
                <div class="ingredient-card" style="margin: 0; padding: 16px; margin-bottom: 12px;">
                    <div style="font-size: 15px; font-weight: 400; margin-bottom: 8px;">Rosemary Oil Treatment</div>
                    <div style="font-size: 13px; color: #6B5B73; margin-bottom: 8px;">Stimulates growth, adds shine</div>
                    <div style="font-size: 12px; color: #8B7D7D;">Mix 3 drops with carrier oil. Massage scalp.</div>
                </div>
                <div class="ingredient-card" style="margin: 0; padding: 16px;">
                    <div style="font-size: 15px; font-weight: 400; margin-bottom: 8px;">Rice Water Rinse</div>
                    <div style="font-size: 13px; color: #6B5B73; margin-bottom: 8px;">Strengthens and smooths hair</div>
                    <div style="font-size: 12px; color: #8B7D7D;">Ferment rice water 24hrs. Use as final rinse.</div>
                </div>
            </div>
            
            <button class="btn" onclick="showTab('routine')">Add to My Routine</button>
        </div>

        <!-- Discover -->
        <div class="screen" id="discover">
            <div class="header">
                <div class="title">Discover</div>
                <div class="subtitle">Clean beauty recommendations</div>
            </div>
            
            <!-- Clean Beauty Toggle -->
            <div class="card" style="margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div style="font-size: 14px; color: #6B5B73;">Show only natural & chemical-free</div>
                    <div style="width: 50px; height: 28px; background: #C4A484; border-radius: 14px; position: relative; cursor: pointer;" onclick="toggleCleanMode(this)">
                        <div style="width: 24px; height: 24px; background: white; border-radius: 50%; position: absolute; top: 2px; right: 2px; transition: all 0.3s;"></div>
                    </div>
                </div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn-ghost" style="padding: 6px 12px; font-size: 11px;">Skin</button>
                    <button class="btn-ghost" style="padding: 6px 12px; font-size: 11px;">Hair</button>
                    <button class="btn-ghost" style="padding: 6px 12px; font-size: 11px;">Dryness</button>
                    <button class="btn-ghost" style="padding: 6px 12px; font-size: 11px;">Sensitive</button>
                </div>
            </div>
            
            <!-- Skin Product -->
            <div class="ingredient-card">
                <div class="ingredient-header">
                    <div>
                        <div style="font-size: 16px; font-weight: 400; margin-bottom: 4px;">Gentle Ceramide Cleanser</div>
                        <div style="font-size: 12px; color: #8B7D7D;">CeraVe ‚Ä¢ Skin Care</div>
                    </div>
                    <div class="match-score">94% Match</div>
                </div>
                
                <div class="ingredients-list">
                    <strong>Key ingredients:</strong> Ceramides, Hyaluronic Acid, Niacinamide
                </div>
                
                <div style="font-size: 12px; color: #6B5B73; margin-bottom: 12px;">
                    <strong>Why recommended:</strong> Matches your hydration needs and sensitivity profile
                </div>
                
                <div style="display: flex; gap: 6px; margin-bottom: 8px;">
                    <span style="background: #E8F5E8; color: #166534; padding: 2px 8px; border-radius: 12px; font-size: 10px;">100% Natural</span>
                    <span style="background: #E8F5E8; color: #166534; padding: 2px 8px; border-radius: 12px; font-size: 10px;">Fragrance-Free</span>
                </div>
                
                <div class="red-flags">
                    <div class="red-flags-title">‚úì Clean Beauty Verified</div>
                    <div style="font-size: 12px; color: #166534;">No parabens, sulfates, silicones, or artificial fragrance</div>
                </div>
            </div>
            
            <!-- Hair Product -->
            <div class="ingredient-card">
                <div class="ingredient-header">
                    <div>
                        <div style="font-size: 16px; font-weight: 400; margin-bottom: 4px;">Sulfate-Free Curl Shampoo</div>
                        <div style="font-size: 12px; color: #8B7D7D;">DevaCurl ‚Ä¢ Hair Care</div>
                    </div>
                    <div class="match-score">89% Match</div>
                </div>
                
                <div class="ingredients-list">
                    <strong>Key ingredients:</strong> Coconut Oil, Shea Butter, Quinoa Protein
                </div>
                
                <div style="font-size: 12px; color: #6B5B73; margin-bottom: 12px;">
                    <strong>Why recommended:</strong> Perfect for your wavy hair type, enhances natural curl pattern
                </div>
                
                <div style="display: flex; gap: 6px; margin-bottom: 8px;">
                    <span style="background: #E8F5E8; color: #166534; padding: 2px 8px; border-radius: 12px; font-size: 10px;">Sulfate-Free</span>
                    <span style="background: #E8F5E8; color: #166534; padding: 2px 8px; border-radius: 12px; font-size: 10px;">Silicone-Free</span>
                </div>
                
                <div class="red-flags">
                    <div class="red-flags-title">‚úì Clean Formula</div>
                    <div style="font-size: 12px; color: #166534;">No harsh sulfates, parabens, or drying alcohols</div>
                </div>
            </div>
        </div>

        <!-- Routine -->
        <div class="screen" id="routine">
            <div class="header">
                <div class="title">Your Routine</div>
                <div class="subtitle">Personalized for your skin</div>
            </div>
            
            <div class="progress-ring">
                <div class="progress-inner">
                    <div class="progress-text">2/4</div>
                    <div class="progress-label">Today</div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">Morning Routine</div>
                
                <div class="routine-item completed" onclick="toggleRoutine(this)">
                    <div class="checkbox checked">‚úì</div>
                    <div style="flex: 1;">
                        <div style="font-size: 14px; font-weight: 400;">Gentle Cleanser</div>
                        <div style="font-size: 12px; color: #8B7D7D;">CeraVe Hydrating</div>
                    </div>
                </div>
                
                <div class="routine-item completed" onclick="toggleRoutine(this)">
                    <div class="checkbox checked">‚úì</div>
                    <div style="flex: 1;">
                        <div style="font-size: 14px; font-weight: 400;">Hydrating Serum</div>
                        <div style="font-size: 12px; color: #8B7D7D;">The Ordinary Hyaluronic</div>
                    </div>
                </div>
                
                <div class="routine-item" onclick="toggleRoutine(this)">
                    <div class="checkbox"></div>
                    <div style="flex: 1;">
                        <div style="font-size: 14px; font-weight: 400;">Moisturizer</div>
                        <div style="font-size: 12px; color: #8B7D7D;">Neutrogena Hydro Boost</div>
                    </div>
                </div>
                
                <div class="routine-item" onclick="toggleRoutine(this)">
                    <div class="checkbox"></div>
                    <div style="flex: 1;">
                        <div style="font-size: 14px; font-weight: 400;">SPF Protection</div>
                        <div style="font-size: 12px; color: #8B7D7D;">EltaMD UV Clear</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Community -->
        <div class="screen" id="community">
            <div class="header">
                <div class="title">Community</div>
                <div class="subtitle">Share your beauty journey</div>
            </div>
            
            <!-- Safety Notice -->
            <div style="background: #F0FDF4; border: 1px solid #BBF7D0; border-radius: 12px; padding: 12px; margin-bottom: 16px; font-size: 13px; color: #166534; text-align: center;">
                üíö Please keep it respectful. RIKA is a safe space.
            </div>
            
            <!-- Post Creation -->
            <div class="card" style="margin-bottom: 16px;">
                <div class="card-title" style="margin-bottom: 12px;">Share your routine or tip</div>
                <textarea id="communityPostContent" placeholder="What's working for your skin or hair today?" style="width: 100%; min-height: 80px; padding: 12px; border: 1px solid #E8DDD4; border-radius: 8px; font-size: 14px; resize: vertical; font-family: inherit; background: #FEFCFA;"></textarea>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                    <div id="charCount" style="font-size: 12px; color: #8B7D7D;">0/280</div>
                    <button id="postButton" onclick="createCommunityPost()" class="btn" style="padding: 8px 16px; font-size: 14px; width: auto;">Post</button>
                </div>
            </div>
            
            <!-- Community Feed -->
            <div id="communityFeed">
                <!-- Posts will be loaded here -->
            </div>
            
            <!-- Loading State -->
            <div id="communityLoading" style="text-align: center; padding: 20px; color: #8B7D7D;">
                <div style="font-size: 32px; margin-bottom: 8px;">üåø</div>
                <div>Loading community posts...</div>
            </div>
        </div>

        <!-- Chat -->
        <div class="screen" id="chat">
            <div class="header">
                <div class="title">RIKA Care AI</div>
                <div class="subtitle">Your personal beauty assistant</div>
            </div>
            
            <div id="chatMessages" style="height: 400px; overflow-y: auto; margin-bottom: 16px; padding: 12px; background: #F9F6F3; border-radius: 12px;">
                <div class="chat-message assistant" style="margin-bottom: 16px;">
                    <div style="background: #FFFFFF; padding: 12px; border-radius: 12px; border: 1px solid #E8DDD4;">
                        <div style="font-size: 14px; color: #6B5B73; margin-bottom: 4px; font-weight: 500;">RIKA Care AI</div>
                        <div style="font-size: 14px; color: #2C2C2C; line-height: 1.4;">Hi! I'm your RIKA Care AI assistant. I can help with skincare advice, product recommendations, and routine guidance. What would you like to know?</div>
                    </div>
                </div>
            </div>
            
            <div id="suggestedQuestions" style="margin-bottom: 16px;"></div>
            
            <div style="display: flex; gap: 8px;">
                <input type="text" id="chatInput" placeholder="Ask me about skincare, products, or routines..." style="flex: 1; padding: 12px; border: 1px solid #E8DDD4; border-radius: 12px; font-size: 14px; background: #FEFCFA;">
                <button onclick="sendMessage()" id="sendButton" style="background: linear-gradient(135deg, #C4A484, #B8A082); color: white; border: none; border-radius: 12px; padding: 12px 16px; font-size: 14px; cursor: pointer;">Send</button>
            </div>
        </div>

        <!-- Profile -->
        <div class="screen" id="profile">
            <div class="header">
                <div class="logo">RC</div>
                <div class="title" id="profileDisplayName">Your Profile</div>
                <div class="subtitle">
                    <span class="verified-badge">Verified</span>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">Personal Information</div>
                <input type="text" id="profileName" class="input" placeholder="Display name" style="margin-bottom: 12px;">
                <input type="number" id="profileAge" class="input" placeholder="Age" style="margin-bottom: 12px;">
                <select id="profileGender" class="input" style="margin-bottom: 12px;">
                    <option value="">Select Gender</option>
                    <option value="female">Female</option>
                    <option value="male">Male</option>
                    <option value="other">Other</option>
                </select>

                <div style="margin-bottom: 16px;">
                    <label style="font-size: 14px; color: #6B5B73; margin-bottom: 4px; display: block;">Language / Idioma / Langue</label>
                    <select id="profileLanguageSelect" onchange="changeProfileLanguage()" class="input" style="margin-bottom: 0;">
                        <option value="en">üá∫üá∏ English</option>
                        <option value="es">üá™üá∏ Espa√±ol</option>
                        <option value="fr">üá´üá∑ Fran√ßais</option>
                    </select>
                </div>

                <button class="btn" onclick="saveProfile()" style="margin-top: 8px;">Save Changes</button>
            </div>
            
            <div class="card">
                <div class="card-title">Privacy Settings</div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                    <span style="font-size: 14px;">Profile Visibility</span>
                    <span style="font-size: 14px; color: #C4A484;">Women Only</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                    <span style="font-size: 14px;">Content Sharing</span>
                    <span style="font-size: 14px; color: #C4A484;">Selective</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="font-size: 14px;">AI Verification</span>
                    <span style="font-size: 14px; color: #4A7C59;">‚úì Verified</span>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">Beauty Profile Settings</div>
                
                <div style="margin-bottom: 16px;">
                    <label style="font-size: 14px; color: #6B5B73; margin-bottom: 4px; display: block;">Primary Skin Concern</label>
                    <select id="skinConcernSelect" class="input" style="margin-bottom: 0;">
                        <option value="">Select concern</option>
                        <option value="dryness">Dryness & Dehydration</option>
                        <option value="acne">Acne & Breakouts</option>
                        <option value="aging">Fine Lines & Aging</option>
                        <option value="sensitivity">Sensitivity & Redness</option>
                        <option value="dullness">Dullness & Uneven Tone</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="font-size: 14px; color: #6B5B73; margin-bottom: 4px; display: block;">Hair Type</label>
                    <select id="hairTypeSelect" class="input" style="margin-bottom: 0;">
                        <option value="">Select hair type</option>
                        <option value="straight">Straight</option>
                        <option value="wavy">Wavy</option>
                        <option value="curly">Curly</option>
                        <option value="coily">Coily</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="font-size: 14px; color: #6B5B73; margin-bottom: 4px; display: block;">Ingredients to Avoid</label>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <label style="font-size: 12px; display: flex; align-items: center; gap: 4px;">
                            <input type="checkbox" id="avoidFragrance"> Fragrance
                        </label>
                        <label style="font-size: 12px; display: flex; align-items: center; gap: 4px;">
                            <input type="checkbox" id="avoidSulfates"> Sulfates
                        </label>
                        <label style="font-size: 12px; display: flex; align-items: center; gap: 4px;">
                            <input type="checkbox" id="avoidSilicones"> Silicones
                        </label>
                        <label style="font-size: 12px; display: flex; align-items: center; gap: 4px;">
                            <input type="checkbox" id="avoidAlcohol"> Alcohol
                        </label>
                    </div>
                </div>
                
                <button class="btn" onclick="saveBeautyProfile()" style="margin-top: 8px;">Update Beauty Profile</button>
            </div>
            
            <div class="card">
                <div class="card-title">Account</div>
                <button class="btn-secondary btn" onclick="logout()">Sign Out</button>
                <button class="btn-ghost btn" onclick="clearSession()" style="margin-top: 8px;">Clear All Data</button>
            </div>
        </div>

        <!-- Product Detail Modal -->
        <div id="productDetailModal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
            <div style="background: #FEFCFA; border-radius: 20px; max-width: 90%; max-height: 90%; overflow-y: auto; position: relative;">
                <button onclick="closeProductDetail()" style="position: absolute; top: 16px; right: 16px; background: #F5F0EB; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 18px; color: #6B5B73;">√ó</button>
                
                <div id="productDetailContent" style="padding: 24px; max-width: 400px;">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- Rewards Store Modal -->
        <div id="rewardsModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; align-items: center; justify-content: center;">
            <div style="background: #FEFCFA; border-radius: 20px; max-width: 90%; max-height: 90%; overflow-y: auto; position: relative;">
                <button onclick="closeRewardsStore()" style="position: absolute; top: 16px; right: 16px; background: #F5F0EB; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 18px; color: #6B5B73;">√ó</button>
                
                <div style="padding: 24px; max-width: 400px;">
                    <div style="text-align: center; margin-bottom: 24px;">
                        <h2 style="font-size: 20px; font-weight: 400; color: #2C2C2C; margin-bottom: 8px;">üéÅ Rewards Store</h2>
                        <p style="font-size: 14px; color: #8B7D7D;">Redeem your points for exclusive rewards</p>
                        <div id="currentPoints" style="background: #F4E4C1; padding: 8px 16px; border-radius: 16px; display: inline-block; margin-top: 8px; font-weight: 600; color: #6B5B73;">‚≠ê 0 points</div>
                    </div>
                    
                    <div id="rewardsList">
                        <!-- Rewards will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">
                <div class="nav-icon">‚óê</div>
                <div>Home</div>
            </button>
            <button class="nav-tab" onclick="showTab('discover')">
                <div class="nav-icon">‚óá</div>
                <div>Discover</div>
            </button>
            <button class="nav-tab" onclick="showTab('routine')">
                <div class="nav-icon">‚óØ</div>
                <div>Routine</div>
            </button>
            <button class="nav-tab" onclick="showTab('community')">
                <div class="nav-icon">üë•</div>
                <div>Community</div>
            </button>
            <button class="nav-tab" onclick="showTab('chat')">
                <div class="nav-icon">üí¨</div>
                <div>AI Chat</div>
            </button>
            <button class="nav-tab" onclick="showTab('profile')">
                <div class="nav-icon">‚óê</div>
                <div>Profile</div>
            </button>
        </div>
    </div>

    <script>
        const API_BASE_URL = window.location.origin;
        const API_BASE = API_BASE_URL + '/api';
        
        // Test API connection
        fetch(API_BASE + '/health').then(r => console.log('API connected')).catch(e => console.error('API connection failed:', e));
        let authToken = localStorage.getItem('rikaToken');
        let userProfile = {
            privacy: 'women',
            skinConcern: null,
            scanData: null,
            verified: false
        };
        let currentUser = null;
        let userRoutines = [];
        let recommendedProducts = [];

        // Check if user is already logged in
        if (authToken) {
            loadUserProfile().then(() => {
                // Check if user needs onboarding
                if (needsPrivacyOnboarding()) {
                    showScreen('privacyFirst');
                } else {
                    showScreen('dashboard');
                    loadDashboardData();
                }
            }).catch(() => {
                // Invalid token, clear and show auth
                localStorage.removeItem('rikaToken');
                authToken = null;
                showScreen('auth');
            });
        } else {
            // No token, show auth screen
            showScreen('auth');
        }
        
        // Load user profile from backend
        async function loadUserProfile() {
            try {
                const response = await fetch(API_BASE + '/user/profile', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    currentUser = await response.json();
                    updateUIWithUserData();
                } else {
                    throw new Error('Invalid session');
                }
            } catch (error) {
                console.error('Failed to load user profile:', error);
                throw error;
            }
        }
        
        // Load recommended products from backend with personalization
        async function loadRecommendedProducts(cleanOnly = false) {
            try {
                // First ensure we have user profile loaded
                if (!currentUser) {
                    await loadUserProfile();
                }
                
                const url = cleanOnly ? 
                    `${API_BASE}/recommendations?cleanOnly=true` : 
                    `${API_BASE}/recommendations`;
                    
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    recommendedProducts = data.products || [];
                    updateProductsUI(data);
                    console.log('‚úÖ Loaded', recommendedProducts.length, 'personalized recommendations');
                } else {
                    console.log('No recommendations available yet');
                    showNoProductsMessage();
                }
            } catch (error) {
                console.error('Failed to load recommendations:', error);
                showNoProductsMessage();
            }
        }
        
        // Load user routines from backend
        async function loadUserRoutines() {
            try {
                const response = await fetch(API_BASE + '/routines', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    userRoutines = await response.json();
                    updateRoutinesUI();
                } else {
                    console.log('No routines found');
                }
            } catch (error) {
                console.error('Failed to load routines:', error);
            }
        }
        
        // Save routine completion to backend
        async function saveRoutineCompletion(routineData) {
            try {
                const response = await fetch(API_BASE + '/routines', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(routineData)
                });
                
                if (response.ok) {
                    const savedRoutine = await response.json();
                    console.log('Routine saved:', savedRoutine);
                } else {
                    console.error('Failed to save routine');
                }
            } catch (error) {
                console.error('Error saving routine:', error);
            }
        }
        
        // Update UI with real user data
        function updateUIWithUserData() {
            if (!currentUser) return;
            
            const userName = currentUser.profile?.personalInfo?.name || 
                           currentUser.email?.split('@')[0]?.replace(/[._]/g, ' ')?.replace(/\b\w/g, l => l.toUpperCase()) || 
                           'User';
            
            // Load saved language preference
            const savedLanguage = currentUser.profile?.preferences?.language || localStorage.getItem('rika-language') || 'en';
            document.getElementById('loginLanguageSelect').value = savedLanguage;
            
            // Update greeting with real name
            updateGreeting(userName);
            
            // Update profile display
            const profileNameEl = document.getElementById('profileDisplayName');
            const profileSuffix = savedLanguage === 'es' ? ' - Perfil' : savedLanguage === 'fr' ? ' - Profil' : '\'s Profile';
            if (profileNameEl) profileNameEl.textContent = userName + profileSuffix;
            
            // Load profile form data
            loadProfileForm();
            
            // Update skin analysis data if available
            if (currentUser.profile?.skinProfile) {
                updateSkinAnalysisUI(currentUser.profile.skinProfile);
            }
            
            // Update verification status
            const isVerified = currentUser.verification?.status === 'verified';
            updateVerificationUI(isVerified);
            
            // Apply language after UI is loaded
            setTimeout(() => updateLanguage(savedLanguage), 100);
        }
        
        // Load profile data into form
        function loadProfileForm() {
            if (!currentUser?.profile?.personalInfo) return;

            const info = currentUser.profile.personalInfo;
            const nameField = document.getElementById('profileName');
            const ageField = document.getElementById('profileAge');
            const genderField = document.getElementById('profileGender');

            if (nameField) nameField.value = info.name || '';
            if (ageField) ageField.value = info.age || '';
            if (genderField) genderField.value = info.gender || '';

            // Load language preference
            const savedLanguage = currentUser.profile?.preferences?.language || localStorage.getItem('rika-language') || 'en';
            const profileLanguageSelect = document.getElementById('profileLanguageSelect');
            if (profileLanguageSelect) profileLanguageSelect.value = savedLanguage;

            // Load beauty profile settings
            const skinProfile = currentUser.profile.skinProfile || {};
            const hairProfile = currentUser.profile.hairProfile || {};

            const skinConcernSelect = document.getElementById('skinConcernSelect');
            const hairTypeSelect = document.getElementById('hairTypeSelect');

            if (skinConcernSelect) skinConcernSelect.value = skinProfile.primaryConcern || '';
            if (hairTypeSelect) hairTypeSelect.value = hairProfile.type || '';

            // Load ingredient preferences
            const avoidIngredients = skinProfile.avoidIngredients || [];
            if (document.getElementById('avoidFragrance')) document.getElementById('avoidFragrance').checked = avoidIngredients.includes('fragrance');
            if (document.getElementById('avoidSulfates')) document.getElementById('avoidSulfates').checked = avoidIngredients.includes('sulfates');
            if (document.getElementById('avoidSilicones')) document.getElementById('avoidSilicones').checked = avoidIngredients.includes('silicones');
            if (document.getElementById('avoidAlcohol')) document.getElementById('avoidAlcohol').checked = avoidIngredients.includes('alcohol');
        }
        
        // Save profile changes
        async function saveProfile() {
            const name = document.getElementById('profileName').value;
            const age = document.getElementById('profileAge').value;
            const gender = document.getElementById('profileGender').value;
            
            if (!name.trim()) {
                alert('Please enter a display name');
                return;
            }
            
            try {
                const updatedProfile = {
                    ...currentUser.profile,
                    personalInfo: {
                        ...currentUser.profile.personalInfo,
                        name: name.trim(),
                        age: age ? parseInt(age) : null,
                        gender: gender || null
                    }
                };
                
                const response = await fetch(API_BASE + '/user/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ profile: updatedProfile })
                });
                
                if (response.ok) {
                    currentUser.profile = updatedProfile;
                    updateUIWithUserData();
                    alert('Profile updated successfully!');
                } else {
                    alert('Failed to update profile');
                }
            } catch (error) {
                alert('Error updating profile');
            }
        }
        
        // Save beauty profile settings
        async function saveBeautyProfile() {
            const skinConcern = document.getElementById('skinConcernSelect').value;
            const hairType = document.getElementById('hairTypeSelect').value;
            
            const avoidIngredients = [];
            if (document.getElementById('avoidFragrance').checked) avoidIngredients.push('fragrance');
            if (document.getElementById('avoidSulfates').checked) avoidIngredients.push('sulfates');
            if (document.getElementById('avoidSilicones').checked) avoidIngredients.push('silicones');
            if (document.getElementById('avoidAlcohol').checked) avoidIngredients.push('alcohol');
            
            try {
                const updatedProfile = {
                    ...currentUser.profile,
                    skinProfile: {
                        ...currentUser.profile.skinProfile,
                        primaryConcern: skinConcern,
                        avoidIngredients: avoidIngredients
                    },
                    hairProfile: {
                        ...currentUser.profile.hairProfile,
                        type: hairType
                    }
                };
                
                const response = await fetch(API_BASE + '/user/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ profile: updatedProfile })
                });
                
                if (response.ok) {
                    currentUser.profile = updatedProfile;
                    alert('Beauty profile updated! Your recommendations will be refreshed.');
                    // Refresh recommendations with new preferences
                    if (document.getElementById('discover').classList.contains('active')) {
                        loadRecommendedProducts();
                    }
                } else {
                    alert('Failed to update beauty profile');
                }
            } catch (error) {
                alert('Error updating beauty profile');
            }
        }
        
        // Update skin analysis UI with real data
        function updateSkinAnalysisUI(skinProfile) {
            // Update skin metrics if available
            const metrics = document.querySelectorAll('.metric');
            if (skinProfile.hydration && metrics[0]) {
                metrics[0].querySelector('.metric-value').textContent = skinProfile.hydration + '%';
            }
            if (skinProfile.oilZones && metrics[1]) {
                metrics[1].querySelector('.metric-value').textContent = skinProfile.oilZones;
            }
        }
        
        // Update products UI with real recommendations
        function updateProductsUI(data = {}) {
            const discoverScreen = document.getElementById('discover');
            if (!discoverScreen) return;
            
            // Find the container for product cards (after the clean beauty toggle)
            const cleanToggleCard = discoverScreen.querySelector('.card');
            const existingProducts = discoverScreen.querySelectorAll('.ingredient-card');
            const existingMessages = discoverScreen.querySelectorAll('.card:not(:first-child)');
            
            // Remove existing product cards and messages
            existingProducts.forEach(card => card.remove());
            existingMessages.forEach(msg => {
                if (msg.textContent.includes('No product recommendations') || 
                    msg.textContent.includes('personalized recommendations')) {
                    msg.remove();
                }
            });
            
            if (recommendedProducts.length === 0) {
                showNoProductsMessage();
                return;
            }
            
            // Show filter results info
            if (data.filteredCount !== undefined && data.totalProducts !== undefined) {
                const filterInfo = `
                    <div class="card" style="background: #F9F6F3; border: 1px solid #E8DDD4; margin-bottom: 16px;">
                        <div style="font-size: 14px; color: #6B5B73; text-align: center;">
                            ‚ú® Showing ${data.filteredCount} personalized recommendations
                            ${data.filteredCount < data.totalProducts ? ` (${data.totalProducts - data.filteredCount} filtered out)` : ''}
                        </div>
                    </div>
                `;
                cleanToggleCard.insertAdjacentHTML('afterend', filterInfo);
            }
            
            // Add real products with enhanced display
            recommendedProducts.slice(0, 8).forEach(product => {
                const productCard = createProductCard(product);
                cleanToggleCard.insertAdjacentHTML('afterend', productCard);
            });
            
            console.log('‚úÖ Updated UI with', recommendedProducts.length, 'personalized products');
        }
        
        // Create enhanced product card HTML with personalization details
        function createProductCard(product) {
            const cleanFlags = [];
            if (product.flags.isNatural) cleanFlags.push('Natural');
            if (product.flags.isFragranceFree) cleanFlags.push('Fragrance-Free');
            if (product.flags.isSulfateFree) cleanFlags.push('Sulfate-Free');
            if (product.flags.isSiliconeFree) cleanFlags.push('Silicone-Free');
            if (product.flags.isCrueltyFree) cleanFlags.push('Cruelty-Free');
            
            const flagsHTML = cleanFlags.map(flag => 
                `<span style="background: #E8F5E8; color: #166534; padding: 2px 8px; border-radius: 12px; font-size: 10px;">${flag}</span>`
            ).join(' ');
            
            // Enhanced match score styling based on percentage
            const matchClass = product.matchPercentage >= 90 ? 'match-score' : 
                              product.matchPercentage >= 75 ? 'match-score' : 'match-score';
            const matchStyle = product.matchPercentage >= 90 ? 'background: #E8F5E8; color: #166534;' :
                              product.matchPercentage >= 75 ? 'background: #FEF3C7; color: #92400E;' :
                              'background: #F3F4F6; color: #6B7280;';
            
            return `
                <div class="ingredient-card" onclick="openProductDetail(${product.id})" style="border-left: 3px solid ${product.matchPercentage >= 90 ? '#10B981' : product.matchPercentage >= 75 ? '#F59E0B' : '#9CA3AF'}; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    <div class="ingredient-header">
                        <div>
                            <div style="font-size: 16px; font-weight: 400; margin-bottom: 4px;">${product.name}</div>
                            <div style="font-size: 12px; color: #8B7D7D;">${product.brand} ‚Ä¢ ${product.type === 'skin' ? 'Skin Care' : 'Hair Care'}</div>
                        </div>
                        <div class="${matchClass}" style="${matchStyle}">${product.matchPercentage}% Match</div>
                    </div>
                    
                    <div class="ingredients-list">
                        <strong>Key ingredients:</strong> ${product.ingredients.join(', ')}
                    </div>
                    
                    <div style="font-size: 12px; color: #6B5B73; margin-bottom: 12px;">
                        <strong>Why recommended:</strong> ${product.whyRecommended}
                    </div>
                    
                    ${flagsHTML ? `<div style="display: flex; gap: 6px; margin-bottom: 8px; flex-wrap: wrap;">${flagsHTML}</div>` : ''}
                    
                    <div class="red-flags" style="background: #F0FDF4; border-color: #BBF7D0;">
                        <div class="red-flags-title" style="color: #166534;">‚úì Personalized Match</div>
                        <div style="font-size: 12px; color: #166534;">Price: $${product.price} ‚Ä¢ Match Score: ${product.matchScore}/100</div>
                    </div>
                </div>
            `;
        }
        
        // Open product detail modal
        async function openProductDetail(productId) {
            try {
                const response = await fetch(`${API_BASE}/products/${productId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const product = await response.json();
                    displayProductDetail(product);
                    document.getElementById('productDetailModal').classList.remove('hidden');
                } else {
                    alert('Failed to load product details');
                }
            } catch (error) {
                alert('Error loading product details');
            }
        }
        
        // Display product detail content
        function displayProductDetail(product) {
            const cleanFlags = [];
            if (product.clean_flags.sulfateFree) cleanFlags.push('Sulfate-Free');
            if (product.clean_flags.siliconeFree) cleanFlags.push('Silicone-Free');
            if (product.clean_flags.fragranceFree) cleanFlags.push('Fragrance-Free');
            if (product.clean_flags.vegan) cleanFlags.push('Vegan');
            if (product.clean_flags.crueltyFree) cleanFlags.push('Cruelty-Free');
            if (product.clean_flags.natural) cleanFlags.push('Natural');
            
            const flagsHTML = cleanFlags.map(flag => 
                `<span style="background: #E8F5E8; color: #166534; padding: 4px 12px; border-radius: 16px; font-size: 12px; margin: 2px;">${flag}</span>`
            ).join(' ');
            
            const benefitsHTML = product.benefits.map(benefit => 
                `<li style="margin-bottom: 8px; color: #6B5B73;">${benefit}</li>`
            ).join('');
            
            const matchStyle = product.matchPercentage >= 90 ? 'background: #E8F5E8; color: #166534;' :
                              product.matchPercentage >= 75 ? 'background: #FEF3C7; color: #92400E;' :
                              'background: #F3F4F6; color: #6B7280;';
            
            document.getElementById('productDetailContent').innerHTML = `
                <div style="text-align: center; margin-bottom: 24px;">
                    <div style="width: 120px; height: 120px; background: #F5F0EB; border-radius: 16px; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center; font-size: 48px;">üß¥</div>
                    <h2 style="font-size: 20px; font-weight: 400; color: #2C2C2C; margin-bottom: 4px;">${product.name}</h2>
                    <p style="font-size: 14px; color: #8B7D7D; margin-bottom: 12px;">${product.brand}</p>
                    <div style="${matchStyle} padding: 6px 16px; border-radius: 20px; display: inline-block; font-weight: 500;">${product.matchPercentage}% Match</div>
                </div>
                
                ${flagsHTML ? `<div style="margin-bottom: 20px; text-align: center;">${flagsHTML}</div>` : ''}
                
                <div style="background: #F9F6F3; padding: 16px; border-radius: 12px; margin-bottom: 20px;">
                    <h3 style="font-size: 14px; font-weight: 600; color: #6B5B73; margin-bottom: 8px;">‚ú® Why RIKA Recommends This</h3>
                    <p style="font-size: 14px; color: #6B5B73; line-height: 1.5;">${product.whyRecommended}</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3 style="font-size: 16px; font-weight: 500; color: #2C2C2C; margin-bottom: 12px;">Key Benefits</h3>
                    <ul style="padding-left: 16px;">${benefitsHTML}</ul>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3 style="font-size: 16px; font-weight: 500; color: #2C2C2C; margin-bottom: 8px;">How to Use</h3>
                    <p style="font-size: 14px; color: #6B5B73; line-height: 1.5;">${product.how_to_use}</p>
                </div>
                
                <details style="margin-bottom: 20px;">
                    <summary style="font-size: 16px; font-weight: 500; color: #2C2C2C; cursor: pointer; padding: 8px 0;">Full Ingredient List</summary>
                    <p style="font-size: 12px; color: #8B7D7D; line-height: 1.4; margin-top: 8px; padding: 12px; background: #F9F6F3; border-radius: 8px;">${product.full_ingredient_list}</p>
                </details>
                
                <div style="display: flex; gap: 12px; margin-top: 24px;">
                    <button onclick="window.open('${product.affiliate_url}', '_blank')" style="flex: 1; background: linear-gradient(135deg, #C4A484, #B8A082); color: white; border: none; border-radius: 12px; padding: 16px; font-size: 16px; font-weight: 500; cursor: pointer;">Buy Now - $${product.price}</button>
                    <button onclick="addToRoutine(${product.id})" style="background: #F5F0EB; color: #6B5B73; border: 1px solid #E8DDD4; border-radius: 12px; padding: 16px; font-size: 14px; cursor: pointer;">Add to Routine</button>
                </div>
            `;
        }
        
        // Close product detail modal
        function closeProductDetail() {
            document.getElementById('productDetailModal').classList.add('hidden');
        }
        
        // Add to routine (stub)
        function addToRoutine(productId) {
            alert('Product added to your routine! (Feature coming soon)');
            closeProductDetail();
        }
        
        // Points & Rewards System
        let userPoints = 0;
        let userStreak = { currentStreak: 0, longestStreak: 0, lastActivityDate: null };
        
        async function loadUserPoints() {
            try {
                const response = await fetch(`${API_BASE}/points`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    userPoints = data.totalPoints;
                    updatePointsDisplay();
                }
            } catch (error) {
                console.log('Could not load points');
            }
        }
        
        async function loadUserStreak() {
            try {
                const response = await fetch(`${API_BASE}/streaks`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    userStreak = await response.json();
                    updateStreakDisplay();
                }
            } catch (error) {
                console.log('Could not load streak');
            }
        }
        
        function updateStreakDisplay() {
            const streakDisplay = document.getElementById('streakDisplay');
            const streakBest = document.getElementById('streakBest');
            const completeBtn = document.getElementById('completeRoutineBtn');
            
            if (!streakDisplay) return;
            
            if (userStreak.currentStreak === 0) {
                streakDisplay.textContent = 'Start your streak today ‚ú®';
                streakBest.textContent = '';
            } else {
                streakDisplay.textContent = `üî• ${userStreak.currentStreak} day streak`;
                streakBest.textContent = `Best: ${userStreak.longestStreak} days`;
            }
            
            // Check if already completed today
            const today = new Date().toISOString().split('T')[0];
            if (userStreak.lastActivityDate === today && completeBtn) {
                completeBtn.textContent = '‚úì Completed Today';
                completeBtn.disabled = true;
                completeBtn.style.background = '#10B981';
            }
        }
        
        async function completeRoutineDay() {
            try {
                const completeBtn = document.getElementById('completeRoutineBtn');
                completeBtn.disabled = true;
                completeBtn.textContent = 'Completing...';
                
                const response = await fetch(`${API_BASE}/routines/complete-day`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    userStreak = data.streak;
                    updateStreakDisplay();
                    
                    // Refresh points
                    loadUserPoints();
                    
                    // Show milestone message if any
                    if (data.milestone) {
                        showStreakMilestone(data.milestone, userStreak.currentStreak);
                    } else {
                        showStreakSuccess(userStreak.currentStreak);
                    }
                } else {
                    const error = await response.json();
                    alert(error.error || 'Failed to complete routine');
                }
            } catch (error) {
                alert('Error completing routine. Please try again.');
            } finally {
                const completeBtn = document.getElementById('completeRoutineBtn');
                completeBtn.disabled = false;
                completeBtn.textContent = 'Complete Today\'s Routine';
            }
        }
        
        function showStreakSuccess(streak) {
            const message = document.createElement('div');
            message.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #FEF3C7; border: 1px solid #FDE68A; color: #92400E;
                padding: 20px; border-radius: 16px; text-align: center;
                box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 2000;
                max-width: 280px; animation: slideIn 0.3s ease;
            `;
            message.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 12px;">üî•</div>
                <h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 500;">Routine Complete!</h3>
                <p style="margin: 0; font-size: 14px;">${streak} day streak and counting!</p>
            `;
            
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.remove();
            }, 3000);
        }
        
        function showStreakMilestone(milestoneText, streak) {
            const message = document.createElement('div');
            message.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #FEF3C7, #FDE68A);
                border: 2px solid #F59E0B; color: #92400E;
                padding: 24px; border-radius: 20px; text-align: center;
                box-shadow: 0 15px 35px rgba(0,0,0,0.15); z-index: 2000;
                max-width: 320px; animation: slideIn 0.3s ease;
            `;
            message.innerHTML = `
                <div style="font-size: 64px; margin-bottom: 16px; animation: bounce 1s infinite;">üèÜ</div>
                <h3 style="margin: 0 0 12px 0; font-size: 20px; font-weight: 600;">Milestone Achieved!</h3>
                <p style="margin: 0 0 8px 0; font-size: 16px; font-weight: 500;">${milestoneText}</p>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 12px;">Bonus points awarded!</div>
            `;
            
            // Add bounce animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes bounce {
                    0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
                    40% { transform: translateY(-10px); }
                    60% { transform: translateY(-5px); }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.remove();
                style.remove();
            }, 5000);
        }
        
        function updatePointsDisplay() {
            const badge = document.getElementById('pointsBadge');
            const current = document.getElementById('currentPoints');
            const dashboard = document.getElementById('dashboardPoints');
            
            if (badge) badge.textContent = `‚≠ê ${userPoints} points`;
            if (current) current.textContent = `‚≠ê ${userPoints} points`;
            if (dashboard) dashboard.textContent = `${userPoints} points`;
            
            // Update next reward indicator
            updateNextRewardIndicator();
        }
        
        function updateNextRewardIndicator() {
            const nextRewardEl = document.getElementById('nextRewardPoints');
            if (!nextRewardEl) return;
            
            // Common reward thresholds
            const rewardThresholds = [100, 150, 200, 300, 500];
            const nextThreshold = rewardThresholds.find(threshold => threshold > userPoints);
            
            if (nextThreshold) {
                nextRewardEl.textContent = `${nextThreshold} pts`;
            } else {
                nextRewardEl.textContent = 'Max level!';
            }
        }
        
        async function addPoints(action, points) {
            try {
                const response = await fetch(`${API_BASE}/points/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ action, points })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    userPoints = data.totalPoints;
                    updatePointsDisplay();
                    
                    // Show points earned notification
                    const notification = document.createElement('div');
                    notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #E8F5E8; color: #166534; padding: 12px 16px; border-radius: 8px; font-size: 14px; z-index: 2000; animation: slideIn 0.3s ease;';
                    notification.textContent = `+${points} points earned!`;
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        notification.remove();
                    }, 3000);
                }
            } catch (error) {
                console.log('Could not add points');
            }
        }
        
        function openRewardsStore() {
            displayRewards();
            document.getElementById('rewardsModal').style.display = 'flex';
        }
        
        function closeRewardsStore() {
            document.getElementById('rewardsModal').style.display = 'none';
        }
        
        async function displayRewards() {
            try {
                const response = await fetch(`${API_BASE}/rewards`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load rewards');
                }
                
                const rewards = await response.json();
                
                const rewardsList = document.getElementById('rewardsList');
                
                if (rewards.length === 0) {
                    rewardsList.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #8B7D7D;">
                            <div style="font-size: 48px; margin-bottom: 12px;">üéÅ</div>
                            <div>No rewards available at the moment</div>
                        </div>
                    `;
                    return;
                }
                
                rewardsList.innerHTML = rewards.map(reward => {
                    const canAfford = userPoints >= reward.required_points;
                    const pointsNeeded = reward.required_points - userPoints;
                    
                    // Get reward type icon
                    const typeIcons = {
                        'DISCOUNT': 'üí∞',
                        'FREE_SAMPLE': 'üì¶',
                        'CONSULTATION': 'üë©‚Äç‚öïÔ∏è',
                        'DIGITAL': 'üì±'
                    };
                    const icon = typeIcons[reward.type] || 'üéÅ';
                    
                    return `
                        <div style="background: ${canAfford ? '#FFFFFF' : '#F9F6F3'}; border: 1px solid ${canAfford ? '#E8DDD4' : '#F0EBE6'}; border-radius: 12px; padding: 16px; margin-bottom: 12px; opacity: ${canAfford ? '1' : '0.6'}; transition: all 0.2s;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 20px;">${icon}</span>
                                    <h3 style="font-size: 16px; font-weight: 500; color: #2C2C2C; margin: 0;">${reward.name}</h3>
                                </div>
                                <div style="background: #F4E4C1; color: #6B5B73; padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 600;">${reward.required_points} pts</div>
                            </div>
                            <p style="font-size: 14px; color: #6B5B73; margin-bottom: 12px; line-height: 1.4;">${reward.description}</p>
                            <button onclick="redeemReward(${reward.id})" ${!canAfford ? 'disabled' : ''} style="background: ${canAfford ? 'linear-gradient(135deg, #C4A484, #B8A082)' : '#E8DDD4'}; color: ${canAfford ? 'white' : '#A69B9B'}; border: none; border-radius: 8px; padding: 10px 16px; font-size: 14px; cursor: ${canAfford ? 'pointer' : 'not-allowed'}; width: 100%; transition: all 0.2s;">
                                ${canAfford ? 'Redeem Now' : `Need ${pointsNeeded} more points`}
                            </button>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading rewards:', error);
                const rewardsList = document.getElementById('rewardsList');
                rewardsList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #DC2626; background: #FFF5F5; border-radius: 8px;">
                        <div>Failed to load rewards. Please try again.</div>
                    </div>
                `;
            }
        }
        
        async function redeemReward(rewardId) {
            try {
                const response = await fetch(`${API_BASE}/rewards/redeem`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ rewardId })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    userPoints = data.totalPoints;
                    updatePointsDisplay();
                    displayRewards(); // Refresh rewards list
                    
                    // Show success message with better styling
                    showRewardSuccessMessage(data.reward, userPoints);
                } else {
                    const error = await response.json();
                    showRewardErrorMessage(error.error || 'Failed to redeem reward');
                }
            } catch (error) {
                showRewardErrorMessage('Connection error. Please try again.');
            }
        }
        
        function showRewardSuccessMessage(rewardName, remainingPoints) {
            const message = document.createElement('div');
            message.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #F0FDF4; border: 1px solid #BBF7D0; color: #166534;
                padding: 24px; border-radius: 16px; text-align: center;
                box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 2000;
                max-width: 300px; animation: slideIn 0.3s ease;
            `;
            message.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 12px;">üéâ</div>
                <h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 500;">Reward Redeemed!</h3>
                <p style="margin: 0 0 12px 0; font-size: 14px;">${rewardName}</p>
                <div style="font-size: 12px; opacity: 0.8;">Remaining: ${remainingPoints} points</div>
                <div style="font-size: 11px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #BBF7D0; opacity: 0.7;">
                    Rewards are virtual benefits; some rewards are placeholders for future integrations.
                </div>
            `;
            
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.remove();
            }, 4000);
        }
        
        function showRewardErrorMessage(errorText) {
            const message = document.createElement('div');
            message.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #FFF5F5; border: 1px solid #FECACA; color: #DC2626;
                padding: 20px; border-radius: 12px; text-align: center;
                box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 2000;
                max-width: 280px;
            `;
            message.innerHTML = `
                <div style="font-size: 32px; margin-bottom: 8px;">‚ö†Ô∏è</div>
                <p style="margin: 0; font-size: 14px;">${errorText}</p>
            `;
            
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.remove();
            }, 3000);
        }
        
        // Show message when no products available
        function showNoProductsMessage() {
            const discoverScreen = document.getElementById('discover');
            if (!discoverScreen) return;
            
            const existingProducts = discoverScreen.querySelectorAll('.ingredient-card');
            existingProducts.forEach(card => card.remove());
            
            const cleanToggleCard = discoverScreen.querySelector('.card');
            const noProductsHTML = `
                <div class="card" style="text-align: center; background: #F9F6F3; border: 1px solid #E8DDD4;">
                    <div style="font-size: 16px; color: #6B5B73; margin-bottom: 12px;">üåø Building your recommendations</div>
                    <div style="font-size: 14px; color: #8B7D7D; margin-bottom: 16px;">Complete your beauty profile for personalized product suggestions.</div>
                    <button class="btn-ghost" style="padding: 8px 16px; font-size: 13px;" onclick="showTab('profile')">Update Profile</button>
                </div>
            `;
            cleanToggleCard.insertAdjacentHTML('afterend', noProductsHTML);
        }
        
        // Update routines UI with real data
        function updateRoutinesUI() {
            if (userRoutines.length === 0) return;
            
            // Calculate real progress
            const completedToday = userRoutines.filter(r => {
                const today = new Date().toDateString();
                const routineDate = new Date(r.date).toDateString();
                return routineDate === today && r.completed;
            }).length;
            
            const totalRoutines = 4; // Default routine items
            const progressText = document.querySelector('.progress-text');
            if (progressText) {
                progressText.textContent = `${completedToday}/${totalRoutines}`;
            }
            
            // Update progress ring
            const ring = document.querySelector('.progress-ring');
            const degrees = (completedToday / totalRoutines) * 360;
            if (ring) {
                ring.style.background = `conic-gradient(#D4A574 0deg ${degrees}deg, #F5F0EB ${degrees}deg 360deg)`;
            }
        }
        
        // Load all dashboard data
        async function loadDashboardData() {
            await Promise.all([
                loadRecommendedProducts(),
                loadUserRoutines(),
                loadUserPoints(),
                loadUserStreak()
            ]);

            // Award daily hydration check points (once per day)
            const lastHydrationCheck = localStorage.getItem('lastHydrationCheck');
            const today = new Date().toDateString();
            if (lastHydrationCheck !== today) {
                addPoints('Daily hydration check', 5);
                localStorage.setItem('lastHydrationCheck', today);
            }

            // Reapply language translations after data loads
            const savedLanguage = localStorage.getItem('rika-language') || 'en';
            setTimeout(() => updateLanguage(savedLanguage), 200);
        }
        
        // Update screens when tabs are shown
        const originalShowTab = showTab;
        showTab = function(tabId) {
            originalShowTab(tabId);
            if (tabId === 'discover' && authToken) {
                // Always reload to ensure fresh personalized data
                const cleanMode = userProfile.cleanBeautyMode || false;
                loadRecommendedProducts(cleanMode);
            } else if (tabId === 'community' && authToken) {
                loadCommunityFeed();
                setTimeout(initCommunityListeners, 100);
            } else if (tabId === 'chat' && authToken) {
                setTimeout(initChatListeners, 100);
            }
        };
        
        // Community Feed Functions
        let communityPosts = [];
        
        async function loadCommunityFeed() {
            try {
                document.getElementById('communityLoading').style.display = 'block';
                document.getElementById('communityFeed').style.display = 'none';
                
                const response = await fetch(`${API_BASE}/community/feed`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    communityPosts = await response.json();
                    displayCommunityFeed();
                } else {
                    throw new Error('Failed to load community feed');
                }
            } catch (error) {
                console.error('Error loading community feed:', error);
                document.getElementById('communityFeed').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #DC2626; background: #FFF5F5; border-radius: 8px;">
                        <div>Failed to load community posts. Please try again.</div>
                    </div>
                `;
            } finally {
                document.getElementById('communityLoading').style.display = 'none';
                document.getElementById('communityFeed').style.display = 'block';
            }
        }
        
        function displayCommunityFeed() {
            const feedContainer = document.getElementById('communityFeed');
            
            if (communityPosts.length === 0) {
                feedContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #8B7D7D;">
                        <div style="font-size: 48px; margin-bottom: 12px;">üåø</div>
                        <div style="font-size: 16px; margin-bottom: 8px;">No posts yet</div>
                        <div style="font-size: 14px;">Be the first to share your beauty routine!</div>
                    </div>
                `;
                return;
            }
            
            feedContainer.innerHTML = communityPosts.map(post => createPostHTML(post)).join('');
        }
        
        function createPostHTML(post) {
            const timeAgo = getTimeAgo(post.createdAt);
            const routineHTML = post.routineSnapshot ? `
                <div style="background: #F9F6F3; border-radius: 8px; padding: 8px; margin-top: 8px; font-size: 12px; color: #6B5B73;">
                    üìã Routine: ${post.routineSnapshot.products ? post.routineSnapshot.products.join(', ') : 'Custom routine'}
                </div>
            ` : '';
            
            return `
                <div class="community-post" style="margin-bottom: 16px;">
                    <div class="post-header">
                        <div class="avatar">${post.user.initials}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 400; font-size: 14px;">${post.user.name}</div>
                            <div style="font-size: 12px; color: #8B7D7D;">${timeAgo}</div>
                        </div>
                    </div>
                    
                    <div class="post-content">${post.content}${routineHTML}</div>
                    
                    <div class="post-actions">
                        <button class="action-btn" onclick="toggleLike(${post.id})" style="color: ${post.userLiked ? '#DC2626' : '#A69B9B'};">
                            ${post.userLiked ? '‚ù§Ô∏è' : 'ü§ç'} <span id="likeCount-${post.id}">${post.likeCount}</span>
                        </button>
                    </div>
                </div>
            `;
        }
        
        async function createCommunityPost() {
            const content = document.getElementById('communityPostContent').value.trim();
            
            if (!content) {
                alert('Please enter some content for your post.');
                return;
            }
            
            if (content.length > 280) {
                alert('Post must be 280 characters or less.');
                return;
            }
            
            try {
                const postButton = document.getElementById('postButton');
                postButton.disabled = true;
                postButton.textContent = 'Posting...';
                
                const response = await fetch(`${API_BASE}/community/post`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ content })
                });
                
                if (response.ok) {
                    const newPost = await response.json();
                    
                    // Clear the input
                    document.getElementById('communityPostContent').value = '';
                    updateCharCount();
                    
                    // Add new post to the top of the feed
                    communityPosts.unshift(newPost);
                    displayCommunityFeed();
                    
                    // Award points for posting (once per day)
                    const lastPostDate = localStorage.getItem('lastCommunityPost');
                    const today = new Date().toDateString();
                    if (lastPostDate !== today) {
                        addPoints('Community post', 10);
                        localStorage.setItem('lastCommunityPost', today);
                    }
                    
                } else {
                    const error = await response.json();
                    alert(error.error || 'Failed to create post');
                }
            } catch (error) {
                alert('Error creating post. Please try again.');
            } finally {
                const postButton = document.getElementById('postButton');
                postButton.disabled = false;
                postButton.textContent = 'Post';
            }
        }
        
        async function toggleLike(postId) {
            try {
                const response = await fetch(`${API_BASE}/community/like`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ postId })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Update the post in our local array
                    const post = communityPosts.find(p => p.id === postId);
                    if (post) {
                        post.userLiked = result.liked;
                        post.likeCount += result.liked ? 1 : -1;
                        
                        // Update the UI
                        const likeCountEl = document.getElementById(`likeCount-${postId}`);
                        if (likeCountEl) {
                            likeCountEl.textContent = post.likeCount;
                        }
                        
                        // Update button appearance
                        const button = likeCountEl.closest('button');
                        if (button) {
                            button.style.color = post.userLiked ? '#DC2626' : '#A69B9B';
                            button.innerHTML = `${post.userLiked ? '‚ù§Ô∏è' : 'ü§ç'} <span id="likeCount-${postId}">${post.likeCount}</span>`;
                        }
                    }
                } else {
                    throw new Error('Failed to toggle like');
                }
            } catch (error) {
                console.error('Error toggling like:', error);
            }
        }
        
        function updateCharCount() {
            const content = document.getElementById('communityPostContent').value;
            const charCount = document.getElementById('charCount');
            const remaining = 280 - content.length;
            
            charCount.textContent = `${content.length}/280`;
            charCount.style.color = remaining < 20 ? '#DC2626' : '#8B7D7D';
            
            const postButton = document.getElementById('postButton');
            postButton.disabled = content.trim().length === 0 || content.length > 280;
        }
        
        function getTimeAgo(dateString) {
            const now = new Date();
            const postDate = new Date(dateString);
            const diffMs = now - postDate;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return postDate.toLocaleDateString();
        }
        
        // Initialize character counter when community tab is shown
        function initCommunityListeners() {
            const textarea = document.getElementById('communityPostContent');
            if (textarea && !textarea.hasListener) {
                textarea.addEventListener('input', updateCharCount);
                textarea.hasListener = true;
                updateCharCount(); // Initial call
            }
        }
        
        // Chat functionality
        let chatHistory = [];
        
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addMessageToChat('user', message);
            input.value = '';
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                const response = await fetch(`${API_BASE}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ message, history: chatHistory })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Remove typing indicator
                    removeTypingIndicator();
                    
                    // Add AI response to chat
                    addMessageToChat('assistant', data.reply);
                    
                    // Update suggested questions
                    updateSuggestedQuestions(data.suggestedFollowUps || []);
                    
                    // Update chat history
                    chatHistory.push({ role: 'user', content: message });
                    chatHistory.push({ role: 'assistant', content: data.reply });
                    
                    // Keep history manageable
                    if (chatHistory.length > 10) {
                        chatHistory = chatHistory.slice(-10);
                    }
                } else {
                    removeTypingIndicator();
                    addMessageToChat('assistant', 'Sorry, I\'m having trouble right now. Please try again in a moment.');
                }
            } catch (error) {
                removeTypingIndicator();
                addMessageToChat('assistant', 'I\'m having connection issues. Please check your internet and try again.');
            }
        }
        
        function addMessageToChat(sender, message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            messageDiv.style.marginBottom = '16px';
            
            const isUser = sender === 'user';
            const bgColor = isUser ? '#E8DDD4' : '#FFFFFF';
            const textColor = isUser ? '#2C2C2C' : '#2C2C2C';
            const senderName = isUser ? 'You' : 'RIKA Care AI';
            const alignment = isUser ? 'margin-left: 20%;' : '';
            
            messageDiv.innerHTML = `
                <div style="background: ${bgColor}; padding: 12px; border-radius: 12px; border: 1px solid #E8DDD4; ${alignment}">
                    <div style="font-size: 14px; color: #6B5B73; margin-bottom: 4px; font-weight: 500;">${senderName}</div>
                    <div style="font-size: 14px; color: ${textColor}; line-height: 1.4;">${message}</div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'chat-message assistant';
            typingDiv.style.marginBottom = '16px';
            
            typingDiv.innerHTML = `
                <div style="background: #FFFFFF; padding: 12px; border-radius: 12px; border: 1px solid #E8DDD4;">
                    <div style="font-size: 14px; color: #6B5B73; margin-bottom: 4px; font-weight: 500;">RIKA Care AI</div>
                    <div style="font-size: 14px; color: #8B7D7D; line-height: 1.4;">Thinking... ü§î</div>
                </div>
            `;
            
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        function updateSuggestedQuestions(questions) {
            const container = document.getElementById('suggestedQuestions');
            
            if (questions.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = `
                <div style="margin-bottom: 8px; font-size: 12px; color: #8B7D7D;">Suggested questions:</div>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    ${questions.map(q => `
                        <button onclick="askSuggestedQuestion('${q.replace(/'/g, "\\'")}')"
                                style="background: #F5F0EB; color: #6B5B73; border: 1px solid #E8DDD4; border-radius: 16px; padding: 6px 12px; font-size: 12px; cursor: pointer;">
                            ${q}
                        </button>
                    `).join('')}
                </div>
            `;
        }
        
        function askSuggestedQuestion(question) {
            document.getElementById('chatInput').value = question;
            sendMessage();
        }
        
        // Initialize chat input listener
        function initChatListeners() {
            const chatInput = document.getElementById('chatInput');
            if (chatInput && !chatInput.hasListener) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
                chatInput.hasListener = true;
            }
        }

        function selectPrivacy(element, value) {
            document.querySelectorAll('.privacy-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            userProfile.privacy = value;
        }

        function selectConcern(element, value) {
            document.querySelectorAll('#skinQuiz .privacy-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            userProfile.skinConcern = value;
            document.getElementById('continueQuiz').disabled = false;
        }

        // Camera variables
        let cameraStream = null;
        let capturedImageData = null;

        async function startScan() {
            // Open camera modal
            document.getElementById('cameraModal').style.display = 'block';
            document.getElementById('cameraView').style.display = 'block';
            document.getElementById('previewView').style.display = 'none';
            document.getElementById('cameraLoading').style.display = 'block';
            document.getElementById('cameraError').style.display = 'none';
            document.getElementById('captureBtn').style.display = 'none';

            try {
                // Request camera access
                const constraints = {
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user' // Front camera
                    }
                };

                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);

                // Attach stream to video element
                const video = document.getElementById('cameraVideo');
                video.srcObject = cameraStream;

                // Hide loading, show capture button
                document.getElementById('cameraLoading').style.display = 'none';
                document.getElementById('captureBtn').style.display = 'block';

            } catch (error) {
                console.error('Camera access error:', error);
                document.getElementById('cameraLoading').style.display = 'none';

                const errorDiv = document.getElementById('cameraError');
                errorDiv.style.display = 'block';

                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorDiv.querySelector('p').textContent = 'üì∑ Camera access denied. Please allow camera permissions in your browser settings.';
                } else if (error.name === 'NotFoundError') {
                    errorDiv.querySelector('p').textContent = 'üì∑ No camera found on this device.';
                } else {
                    errorDiv.querySelector('p').textContent = 'üì∑ Unable to access camera. Please try again.';
                }
            }
        }

        function captureImage() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            const context = canvas.getContext('2d');

            // Set canvas dimensions to match video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Draw video frame to canvas (flip horizontally to match preview)
            context.save();
            context.scale(-1, 1);
            context.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
            context.restore();

            // Get image data as base64
            capturedImageData = canvas.toDataURL('image/jpeg', 0.8);

            // Stop camera stream
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }

            // Show preview
            document.getElementById('capturedImage').src = capturedImageData;
            document.getElementById('cameraView').style.display = 'none';
            document.getElementById('previewView').style.display = 'block';

            // Send to backend for analysis
            sendForAnalysis(capturedImageData);
        }

        async function sendForAnalysis(imageData) {
            // Show loading
            document.getElementById('analysisLoading').style.display = 'block';
            document.getElementById('analysisResult').style.display = 'none';

            try {
                const response = await fetch(API_BASE + '/skin-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ image: imageData })
                });

                const data = await response.json();

                // Simulate analysis delay
                setTimeout(() => {
                    document.getElementById('analysisLoading').style.display = 'none';
                    document.getElementById('analysisResult').style.display = 'block';

                    // Store analysis data
                    if (data.success) {
                        userProfile.scanData = data.analysis || {
                            hydration: 72,
                            oilZones: 'medium',
                            redness: 'low',
                            poreSize: 'fine'
                        };
                    }
                }, 2000);

            } catch (error) {
                console.error('Analysis error:', error);
                document.getElementById('analysisLoading').style.display = 'none';
                document.getElementById('analysisResult').style.display = 'block';
                document.getElementById('analysisResult').querySelector('p').innerHTML = '‚ö†Ô∏è <strong>Analysis paused</strong><br><span style="font-size: 14px;">AI features coming soon</span>';
            }
        }

        function retakePhoto() {
            capturedImageData = null;
            startScan();
        }

        function finishCapture() {
            closeCameraModal();
            showScreen('skinReport');
        }

        function closeCameraModal() {
            // Stop camera stream if active
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }

            // Hide modal
            document.getElementById('cameraModal').style.display = 'none';

            // Reset video
            const video = document.getElementById('cameraVideo');
            video.srcObject = null;
        }

        // Authentication Functions
        function showSignupForm() {
            document.getElementById('signupForm').classList.remove('hidden');
            document.getElementById('loginForm').classList.add('hidden');
            clearAuthError();
        }
        
        function showLoginForm() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('signupForm').classList.add('hidden');
            clearAuthError();
        }
        
        async function signup() {
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const name = document.getElementById('signupName').value;
            
            if (!email || !password || !name) {
                showAuthError('Please fill in all fields');
                return;
            }
            
            const basicProfile = {
                personalInfo: { name },
                community: { allowMatching: true }
            };
            
            try {
                const response = await fetch(API_BASE + '/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, profile: basicProfile })
                });
                
                const data = await response.json();
                console.log('Signup response:', data);
                
                if (data.success) {
                    authToken = data.token;
                    localStorage.setItem('rikaToken', authToken);
                    currentUser = data.user;
                    showScreen('privacyFirst');
                } else {
                    if (data.message === 'User already exists') {
                        showUserExistsError(email);
                    } else {
                        showAuthError(data.message || 'Account creation failed');
                    }
                }
            } catch (error) {
                console.error('Signup error:', error);
                showAuthError('Connection error. Please try again.');
            }
        }
        
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showAuthError('Please fill in all fields');
                return;
            }

            try {
                const response = await fetch(API_BASE + '/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (data.success) {
                    authToken = data.token;
                    localStorage.setItem('rikaToken', authToken);
                    currentUser = data.user;

                    // Check if user needs onboarding
                    if (needsPrivacyOnboarding()) {
                        showScreen('privacyFirst');
                    } else {
                        showScreen('dashboard');
                        loadDashboardData();
                    }
                } else {
                    if (data.message === 'Invalid credentials') {
                        showAuthError('Wrong email or password. Please try again.');
                    } else {
                        showAuthError(data.message || 'Login failed');
                    }
                }
            } catch (error) {
                showAuthError('Connection error. Please try again.');
            }
        }

        // Google OAuth Sign-In
        function signInWithGoogle() {
            // Redirect to backend Google OAuth route
            window.location.href = API_BASE + '/auth/google';
        }

        // Handle OAuth callback with token
        async function handleOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const email = urlParams.get('email');
            const error = urlParams.get('error');

            if (error) {
                showAuthError('Google sign-in failed. Please try again.');
                // Clean URL
                window.history.replaceState({}, document.title, '/');
                return;
            }

            if (token && email) {
                try {
                    // Store token
                    authToken = token;
                    localStorage.setItem('rikaToken', authToken);

                    // Fetch user profile
                    const response = await fetch(API_BASE + '/user/profile', {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });

                    const data = await response.json();
                    currentUser = {
                        email: data.email,
                        profile: data.profile
                    };

                    // Clean URL
                    window.history.replaceState({}, document.title, '/');

                    // Check if user needs onboarding
                    if (needsPrivacyOnboarding()) {
                        showScreen('privacyFirst');
                    } else {
                        showScreen('dashboard');
                        loadDashboardData();
                    }
                } catch (error) {
                    console.error('OAuth profile fetch error:', error);
                    showAuthError('Failed to load profile. Please try again.');
                    window.history.replaceState({}, document.title, '/');
                }
            }
        }

        // Check for OAuth callback on page load
        window.addEventListener('DOMContentLoaded', () => {
            handleOAuthCallback();
        });
        
        async function saveVisibilityAndContinue() {
            const selectedOption = document.querySelector('.privacy-option.selected');
            if (!selectedOption) {
                showAuthError('Please select a visibility option');
                return;
            }
            
            const visibility = selectedOption.onclick.toString().match(/'([^']+)'/)[1];
            
            // Update user profile locally and continue
            if (!currentUser.profile.community) currentUser.profile.community = {};
            currentUser.profile.community.profileVisibility = visibility;
            
            // Save to backend and award points for profile completion
            try {
                await fetch(API_BASE + '/user/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ profile: currentUser.profile })
                });
                
                // Award points for completing beauty profile
                addPoints('Completed beauty profile setup', 30);
            } catch (error) {
                console.log('Profile update will be saved later');
            }
            
            showScreen('beautyProfile');
        }
        
        // Helper function for testing - clear all session data
        function clearSession() {
            if (confirm('This will clear all your data and log you out. Continue?')) {
                localStorage.clear();
                sessionStorage.clear();
                location.reload();
            }
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');

            // Hide navigation for auth and onboarding screens
            const navTabs = document.querySelector('.nav-tabs');
            const hideNavScreens = ['auth', 'privacyFirst', 'beautyProfile', 'skinQuiz', 'aiScan', 'skinReport', 'hairAnalysis', 'hairReport'];
            if (hideNavScreens.includes(screenId)) {
                navTabs.style.display = 'none';
            } else {
                navTabs.style.display = 'flex';
            }

            // Apply language translations to the newly shown screen
            const savedLanguage = localStorage.getItem('rika-language') || 'en';
            setTimeout(() => updateLanguage(savedLanguage), 50);
        }

        function showTab(tabId) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            event.target.closest('.nav-tab').classList.add('active');
            showScreen(tabId);
        }

        function toggleRoutine(element) {
            const checkbox = element.querySelector('.checkbox');
            const isCompleted = element.classList.contains('completed');
            const routineName = element.querySelector('div[style*="font-weight: 400"]').textContent;
            
            if (isCompleted) {
                element.classList.remove('completed');
                checkbox.classList.remove('checked');
                checkbox.textContent = '';
            } else {
                element.classList.add('completed');
                checkbox.classList.add('checked');
                checkbox.textContent = '‚úì';
                
                // Save completion to backend and award points
                if (authToken) {
                    saveRoutineCompletion({
                        type: 'morning',
                        products: [routineName],
                        completed: true,
                        notes: 'Completed via web app'
                    });
                    
                    // Award points for completing routine
                    addPoints('Completed routine step', 10);
                }
            }
            
            updateProgress();
            
            // Check if routine is 100% complete and trigger streak update
            const total = document.querySelectorAll('.routine-item').length;
            const completed = document.querySelectorAll('.routine-item.completed').length;
            
            if (completed === total && authToken) {
                // Routine 100% complete - update streak
                setTimeout(() => {
                    completeRoutineDay();
                }, 1000); // Small delay for better UX
            }
        }

        function updateProgress() {
            const total = document.querySelectorAll('.routine-item').length;
            const completed = document.querySelectorAll('.routine-item.completed').length;
            const percentage = Math.round((completed / total) * 100);
            
            document.querySelector('.progress-text').textContent = `${completed}/${total}`;
            
            // Update progress ring
            const ring = document.querySelector('.progress-ring');
            const degrees = (completed / total) * 360;
            ring.style.background = `conic-gradient(#C4A484 0deg ${degrees}deg, #F5F0EB ${degrees}deg 360deg)`;
        }

        function logout() {
            localStorage.removeItem('rikaToken');
            authToken = null;
            currentUser = null;
            userProfile = {
                privacy: 'women',
                skinConcern: null,
                scanData: null,
                verified: false
            };
            showScreen('auth');
            // Reset to signup form by default
            showSignupForm();
        }
        
        function showAuthError(message) {
            const errorEl = document.getElementById('authError');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
            setTimeout(() => errorEl.classList.add('hidden'), 5000);
        }
        
        function clearAuthError() {
            const errorEl = document.getElementById('authError');
            errorEl.classList.add('hidden');
        }

        function togglePasswordVisibility(inputId, toggleIcon) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                toggleIcon.textContent = 'üôà';
            } else {
                input.type = 'password';
                toggleIcon.textContent = 'üëÅÔ∏è';
            }
        }
        
        function showUserExistsError(email) {
            const errorEl = document.getElementById('authError');
            errorEl.innerHTML = `
                <div style="margin-bottom: 12px;">User already exists with this email.</div>
                <button class="btn-ghost" style="padding: 8px 16px; font-size: 13px;" onclick="switchToLoginWithEmail('${email}')">Go to Login</button>
            `;
            errorEl.classList.remove('hidden');
        }
        
        function switchToLoginWithEmail(email) {
            showLoginForm();
            document.getElementById('loginEmail').value = email;
            clearAuthError();
        }
        
        function needsPrivacyOnboarding() {
            return !currentUser?.profile?.community?.profileVisibility;
        }

        // Dynamic greeting based on time and user
        function updateGreeting(userName = null) {
            const hour = new Date().getHours();
            const greetingEl = document.getElementById('personalGreeting');
            
            // Get user name from currentUser or extract from email
            const displayName = userName || 
                               currentUser?.profile?.personalInfo?.name || 
                               currentUser?.email?.split('@')[0]?.replace(/[._]/g, ' ')?.replace(/\b\w/g, l => l.toUpperCase()) || 
                               'User';
            
            const greetings = {
                morning: [
                    `Good morning, ${displayName} üåø`,
                    `Good morning, ${displayName} ‚Äî your skin looks great today ‚ú®`,
                    `Good morning, ${displayName} üíõ`
                ],
                afternoon: [
                    `Good afternoon, ${displayName} ‚ú®`,
                    `Hello ${displayName}, hope your day is going well üåø`,
                    `Afternoon, ${displayName} üíõ`
                ],
                evening: [
                    `Good evening, ${displayName} üåô`,
                    `Evening, ${displayName} ‚Äî time for your night routine ‚ú®`,
                    `Hello ${displayName}, winding down? üíõ`
                ]
            };
            
            let timeOfDay = 'morning';
            if (hour >= 12 && hour < 17) timeOfDay = 'afternoon';
            else if (hour >= 17) timeOfDay = 'evening';
            
            const randomGreeting = greetings[timeOfDay][Math.floor(Math.random() * greetings[timeOfDay].length)];
            if (greetingEl) greetingEl.textContent = randomGreeting;
        }
        
        // Trigger animations on dashboard load
        function initDashboardAnimations() {
            const progressRing = document.getElementById('progressRing');
            if (progressRing) {
                setTimeout(() => {
                    progressRing.classList.add('animate');
                }, 300);
            }
        }
        
        function startHairScan() {
            // Simulate hair AI scanning
            setTimeout(() => {
                userProfile.hairData = {
                    type: 'wavy',
                    scalp: 'balanced',
                    frizzRisk: 'low',
                    damage: 'minimal'
                };
                showScreen('hairReport');
            }, 3000);
            
            // Show scanning animation
            const scanInterface = document.querySelector('#hairAnalysis .scan-interface');
            if (scanInterface) {
                scanInterface.style.opacity = '0.5';
                setTimeout(() => {
                    scanInterface.style.opacity = '1';
                }, 3000);
            }
        }
        
        // Real-time clean beauty filter toggle
        function toggleCleanMode(toggle) {
            const slider = toggle.querySelector('div');
            const isActive = slider.style.right === '2px';
            
            if (isActive) {
                // Turn off clean filter
                slider.style.right = 'auto';
                slider.style.left = '2px';
                toggle.style.background = '#E8DDD4';
                userProfile.cleanBeautyMode = false;
                
                // Reload all products
                if (authToken) {
                    loadRecommendedProducts(false);
                }
            } else {
                // Turn on clean filter
                slider.style.left = 'auto';
                slider.style.right = '2px';
                toggle.style.background = '#C4A484';
                userProfile.cleanBeautyMode = true;
                
                // Reload with clean filter
                if (authToken) {
                    loadRecommendedProducts(true);
                }
            }
        }
        
        const translations = {
            en: {
                welcome: 'Welcome to RIKA Care',
                tagline: 'AI-powered skincare for authentic results',
                createAccount: 'Create Account',
                login: 'Log In',
                email: 'Email address',
                password: 'Password',
                name: 'Display name',
                alreadyAccount: 'Already have an account? Log in',
                needAccount: 'Need an account? Sign up',
                // Privacy First
                privacyFirst: 'Privacy First',
                chooseYourVisibility: 'Choose your visibility',
                changeAnytime: 'You can change this anytime in settings',
                whoCanSeeContent: 'Who can see your content?',
                chooseWhoCanSee: 'Choose who can see your content and interact with you.',
                women: 'Women',
                men: 'Men',
                everyone: 'Everyone',
                onlyMe: 'Only Me',
                continue: 'Continue',
                // Beauty Profile
                completeYourProfile: 'Complete Your Profile',
                helpUsPersonalize: 'Help us personalize your experience',
                tellUsAboutYourself: 'Tell us about yourself',
                optionalButRecommended: 'Optional but Recommended',
                thisHelpsProvide: 'This helps us provide better recommendations and connect you with similar users.',
                continueToSkinQuiz: 'Continue to Skin Quiz',
                skipForNow: 'Skip for Now',
                // Skin Quiz
                knowYourSkin: 'Know Your Skin',
                quickAssessment: 'Quick assessment for personalized guidance',
                whatPrimaryConcern: 'What\'s your primary skin concern?',
                drynessDehydration: 'Dryness & Dehydration',
                acneBreakouts: 'Acne & Breakouts',
                fineLinesAging: 'Fine Lines & Aging',
                sensitivityRedness: 'Sensitivity & Redness',
                dullnessUnevenTone: 'Dullness & Uneven Tone',
                continueToAIScan: 'Continue to AI Scan',
                skipScanForNow: 'Skip Scan for Now',
                // Dashboard
                naturalBeautyDashboard: 'Your natural beauty dashboard',
                naturalGlowScore: 'Your Natural Glow Score',
                thisWeekWellness: 'This week\'s wellness journey',
                yourSkinToday: 'Your Skin Today',
                yourHairToday: 'Your Hair Today',
                beautyBite: 'Beauty Bite of the Day',
                ingredientAlerts: 'Ingredient Alerts',
                yourRewards: 'Your Rewards',
                naturalTreatment: 'Natural Treatment',
                viewRoutines: 'View My Routines',
                skinMood: 'Skin mood',
                hairMood: 'Hair mood',
                hydrationReminder: 'Hydration reminder',
                availableRewards: 'Available Rewards',
                openRewardsStore: 'Open Rewards Store',
                // Navigation
                home: 'Home',
                discover: 'Discover',
                routine: 'Routine',
                natural: 'Natural',
                profile: 'Profile',
                // Profile
                yourProfile: 'Your Profile',
                personalInfo: 'Personal Information',
                beautyProfileSettings: 'Beauty Profile Settings',
                saveChanges: 'Save Changes',
                updateBeautyProfile: 'Update Beauty Profile',
                // Routine
                yourRoutine: 'Your Routine',
                personalizedSkin: 'Personalized for your skin',
                morningRoutine: 'Morning Routine',
                today: 'Today'
            },
            es: {
                welcome: 'Bienvenida a RIKA Care',
                tagline: 'Cuidado de la piel con IA para resultados aut√©nticos',
                createAccount: 'Crear Cuenta',
                login: 'Iniciar Sesi√≥n',
                email: 'Correo electr√≥nico',
                password: 'Contrase√±a',
                name: 'Nombre para mostrar',
                alreadyAccount: '¬øYa tienes cuenta? Inicia sesi√≥n',
                needAccount: '¬øNecesitas una cuenta? Reg√≠strate',
                // Privacy First
                privacyFirst: 'Privacidad Primero',
                chooseYourVisibility: 'Elige tu visibilidad',
                changeAnytime: 'Puedes cambiar esto en cualquier momento en la configuraci√≥n',
                whoCanSeeContent: '¬øQui√©n puede ver tu contenido?',
                chooseWhoCanSee: 'Elige qui√©n puede ver tu contenido e interactuar contigo.',
                women: 'Mujeres',
                men: 'Hombres',
                everyone: 'Todos',
                onlyMe: 'Solo Yo',
                continue: 'Continuar',
                // Beauty Profile
                completeYourProfile: 'Completa Tu Perfil',
                helpUsPersonalize: 'Ay√∫danos a personalizar tu experiencia',
                tellUsAboutYourself: 'Cu√©ntanos sobre ti',
                optionalButRecommended: 'Opcional pero Recomendado',
                thisHelpsProvide: 'Esto nos ayuda a proporcionar mejores recomendaciones y conectarte con usuarios similares.',
                continueToSkinQuiz: 'Continuar al Cuestionario de Piel',
                skipForNow: 'Omitir por Ahora',
                // Skin Quiz
                knowYourSkin: 'Conoce Tu Piel',
                quickAssessment: 'Evaluaci√≥n r√°pida para orientaci√≥n personalizada',
                whatPrimaryConcern: '¬øCu√°l es tu principal preocupaci√≥n de piel?',
                drynessDehydration: 'Sequedad y Deshidrataci√≥n',
                acneBreakouts: 'Acn√© y Brotes',
                fineLinesAging: 'L√≠neas Finas y Envejecimiento',
                sensitivityRedness: 'Sensibilidad y Rojeces',
                dullnessUnevenTone: 'Opacidad y Tono Irregular',
                continueToAIScan: 'Continuar al An√°lisis IA',
                skipScanForNow: 'Omitir An√°lisis por Ahora',
                // Dashboard
                naturalBeautyDashboard: 'Tu panel de belleza natural',
                naturalGlowScore: 'Tu Puntuaci√≥n de Brillo Natural',
                thisWeekWellness: 'Tu viaje de bienestar esta semana',
                yourSkinToday: 'Tu Piel Hoy',
                yourHairToday: 'Tu Cabello Hoy',
                beautyBite: 'Consejo de Belleza del D√≠a',
                ingredientAlerts: 'Alertas de Ingredientes',
                yourRewards: 'Tus Recompensas',
                naturalTreatment: 'Tratamiento Natural',
                viewRoutines: 'Ver Mis Rutinas',
                skinMood: 'Estado de la piel',
                hairMood: 'Estado del cabello',
                hydrationReminder: 'Recordatorio de hidrataci√≥n',
                availableRewards: 'Recompensas Disponibles',
                openRewardsStore: 'Abrir Tienda de Recompensas',
                // Navigation
                home: 'Inicio',
                discover: 'Descubrir',
                routine: 'Rutina',
                natural: 'Natural',
                profile: 'Perfil',
                // Profile
                yourProfile: 'Tu Perfil',
                personalInfo: 'Informaci√≥n Personal',
                beautyProfileSettings: 'Configuraci√≥n del Perfil de Belleza',
                saveChanges: 'Guardar Cambios',
                updateBeautyProfile: 'Actualizar Perfil de Belleza',
                // Routine
                yourRoutine: 'Tu Rutina',
                personalizedSkin: 'Personalizada para tu piel',
                morningRoutine: 'Rutina Matutina',
                today: 'Hoy'
            },
            fr: {
                welcome: 'Bienvenue sur RIKA Care',
                tagline: 'Soins de la peau IA pour des r√©sultats authentiques',
                createAccount: 'Cr√©er un Compte',
                login: 'Se Connecter',
                email: 'Adresse e-mail',
                password: 'Mot de passe',
                name: 'Nom d\'affichage',
                alreadyAccount: 'Vous avez d√©j√† un compte? Connectez-vous',
                needAccount: 'Besoin d\'un compte? Inscrivez-vous',
                // Privacy First
                privacyFirst: 'Confidentialit√© d\'Abord',
                chooseYourVisibility: 'Choisissez votre visibilit√©',
                changeAnytime: 'Vous pouvez changer cela √† tout moment dans les param√®tres',
                whoCanSeeContent: 'Qui peut voir votre contenu?',
                chooseWhoCanSee: 'Choisissez qui peut voir votre contenu et interagir avec vous.',
                women: 'Femmes',
                men: 'Hommes',
                everyone: 'Tout le Monde',
                onlyMe: 'Seulement Moi',
                continue: 'Continuer',
                // Beauty Profile
                completeYourProfile: 'Compl√©tez Votre Profil',
                helpUsPersonalize: 'Aidez-nous √† personnaliser votre exp√©rience',
                tellUsAboutYourself: 'Parlez-nous de vous',
                optionalButRecommended: 'Optionnel mais Recommand√©',
                thisHelpsProvide: 'Cela nous aide √† fournir de meilleures recommandations et √† vous connecter avec des utilisateurs similaires.',
                continueToSkinQuiz: 'Continuer au Quiz Peau',
                skipForNow: 'Passer pour l\'Instant',
                // Skin Quiz
                knowYourSkin: 'Connaissez Votre Peau',
                quickAssessment: '√âvaluation rapide pour des conseils personnalis√©s',
                whatPrimaryConcern: 'Quelle est votre principale pr√©occupation cutan√©e?',
                drynessDehydration: 'S√©cheresse et D√©shydratation',
                acneBreakouts: 'Acn√© et √âruptions',
                fineLinesAging: 'Rides et Vieillissement',
                sensitivityRedness: 'Sensibilit√© et Rougeurs',
                dullnessUnevenTone: 'Teint Terne et Irr√©gulier',
                continueToAIScan: 'Continuer √† l\'Analyse IA',
                skipScanForNow: 'Passer l\'Analyse pour l\'Instant',
                // Dashboard
                naturalBeautyDashboard: 'Votre tableau de beaut√© naturelle',
                naturalGlowScore: 'Votre Score d\'√âclat Naturel',
                thisWeekWellness: 'Votre parcours bien-√™tre cette semaine',
                yourSkinToday: 'Votre Peau Aujourd\'hui',
                yourHairToday: 'Vos Cheveux Aujourd\'hui',
                beautyBite: 'Conseil Beaut√© du Jour',
                ingredientAlerts: 'Alertes d\'Ingr√©dients',
                yourRewards: 'Vos R√©compenses',
                naturalTreatment: 'Traitement Naturel',
                viewRoutines: 'Voir Mes Routines',
                skinMood: 'Humeur de la peau',
                hairMood: 'Humeur des cheveux',
                hydrationReminder: 'Rappel d\'hydratation',
                availableRewards: 'R√©compenses Disponibles',
                openRewardsStore: 'Ouvrir la Boutique de R√©compenses',
                // Navigation
                home: 'Accueil',
                discover: 'D√©couvrir',
                routine: 'Routine',
                natural: 'Naturel',
                profile: 'Profil',
                // Profile
                yourProfile: 'Votre Profil',
                personalInfo: 'Informations Personnelles',
                beautyProfileSettings: 'Param√®tres du Profil Beaut√©',
                saveChanges: 'Enregistrer les Modifications',
                updateBeautyProfile: 'Mettre √† Jour le Profil Beaut√©',
                // Routine
                yourRoutine: 'Votre Routine',
                personalizedSkin: 'Personnalis√©e pour votre peau',
                morningRoutine: 'Routine Matinale',
                today: 'Aujourd\'hui'
            }
        };
        
        function updateLanguage(lang) {
            const t = translations[lang];

            // Store elements with their translation keys using data attributes
            // This ensures we always translate from the key, not from current text

            // Login screen
            const titleEl = document.querySelector('.title');
            const taglineEl = document.querySelector('.tagline');
            if (titleEl) titleEl.textContent = t.welcome;
            if (taglineEl) taglineEl.textContent = t.tagline;

            const signupTitle = document.querySelector('#signupForm .card-title');
            const loginTitle = document.querySelector('#loginForm .card-title');
            if (signupTitle) signupTitle.textContent = t.createAccount;
            if (loginTitle) loginTitle.textContent = t.login;

            const signupEmail = document.getElementById('signupEmail');
            const signupPassword = document.getElementById('signupPassword');
            const signupName = document.getElementById('signupName');
            const loginEmail = document.getElementById('loginEmail');
            const loginPassword = document.getElementById('loginPassword');

            if (signupEmail) signupEmail.placeholder = t.email;
            if (signupPassword) signupPassword.placeholder = t.password;
            if (signupName) signupName.placeholder = t.name;
            if (loginEmail) loginEmail.placeholder = t.email;
            if (loginPassword) loginPassword.placeholder = t.password;

            const signupBtn = document.querySelector('#signupForm .btn');
            const loginBtn = document.querySelector('#loginForm .btn');
            const signupGhost = document.querySelector('#signupForm .btn-ghost');
            const loginGhost = document.querySelector('#loginForm .btn-ghost');

            if (signupBtn) signupBtn.textContent = t.createAccount;
            if (loginBtn) loginBtn.textContent = t.login;
            if (signupGhost) signupGhost.textContent = t.alreadyAccount;
            if (loginGhost) loginGhost.textContent = t.needAccount;

            // Dashboard content
            const dashboardSubtitle = document.querySelector('#dashboard .title + div');
            if (dashboardSubtitle) dashboardSubtitle.textContent = t.naturalBeautyDashboard;

            // Build a reverse lookup map from ALL language texts to their keys
            // This allows matching text in any language to find its key
            const textToKeyMap = {};
            Object.keys(translations).forEach(langCode => {
                Object.keys(translations[langCode]).forEach(key => {
                    const text = translations[langCode][key];
                    if (text && typeof text === 'string') {
                        textToKeyMap[text] = key;
                    }
                });
            });

            // Translate all text content by finding the key first
            document.querySelectorAll('*').forEach(el => {
                if (el.children.length === 0 && el.textContent.trim()) {
                    const text = el.textContent.trim();
                    const cleanText = text.replace(/üåü|üå∏|üåø|ü•ë|‚ö†Ô∏è|üéÅ|üå±|‚óê|‚óá|‚óØ/g, '').trim();

                    // Find the translation key for this text (could be in any language)
                    const translationKey = textToKeyMap[cleanText];

                    if (translationKey && t[translationKey]) {
                        const icon = text.match(/üåü|üå∏|üåø|ü•ë|‚ö†Ô∏è|üéÅ|üå±|‚óê|‚óá|‚óØ/)?.[0] || '';
                        el.textContent = icon + (icon ? ' ' : '') + t[translationKey];
                    }
                }
            });

            // Navigation
            const navTexts = [t.home, t.discover, t.routine, t.community || 'Community', t.aiChat || 'AI Chat', t.profile];
            document.querySelectorAll('.nav-tab div:last-child').forEach((el, i) => {
                if (navTexts[i]) el.textContent = navTexts[i];
            });
        }
        
        async function changeLoginLanguage() {
            const selectedLanguage = document.getElementById('loginLanguageSelect').value;
            localStorage.setItem('rika-language', selectedLanguage);
            updateLanguage(selectedLanguage);

            // Save to user profile if logged in
            if (authToken && currentUser) {
                try {
                    const updatedProfile = {
                        ...currentUser.profile,
                        preferences: {
                            ...currentUser.profile.preferences,
                            language: selectedLanguage
                        }
                    };

                    await fetch(API_BASE + '/user/profile', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({ profile: updatedProfile })
                    });

                    currentUser.profile = updatedProfile;
                } catch (error) {
                    console.log('Language preference will be saved later');
                }
            }
        }

        async function changeProfileLanguage() {
            const selectedLanguage = document.getElementById('profileLanguageSelect').value;
            localStorage.setItem('rika-language', selectedLanguage);
            updateLanguage(selectedLanguage);

            // Save to user profile
            if (authToken && currentUser) {
                try {
                    const updatedProfile = {
                        ...currentUser.profile,
                        preferences: {
                            ...currentUser.profile.preferences,
                            language: selectedLanguage
                        }
                    };

                    await fetch(API_BASE + '/user/profile', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({ profile: updatedProfile })
                    });

                    currentUser.profile = updatedProfile;

                    // Show success feedback
                    const notification = document.createElement('div');
                    notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #E8F5E8; color: #166534; padding: 12px 16px; border-radius: 8px; font-size: 14px; z-index: 2000; animation: slideIn 0.3s ease;';
                    notification.textContent = 'Language updated successfully!';
                    document.body.appendChild(notification);

                    setTimeout(() => {
                        notification.remove();
                    }, 3000);
                } catch (error) {
                    console.log('Language preference will be saved later');
                }
            }
        }
        
        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('SW registered'))
                    .catch(error => console.log('SW registration failed'));
            });
        }
        
        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button after user is logged in
            if (authToken) {
                setTimeout(() => {
                    const installBtn = document.createElement('div');
                    installBtn.innerHTML = `
                        <div style="position: fixed; top: 20px; right: 20px; background: #C4A484; color: white; padding: 8px 12px; border-radius: 8px; font-size: 12px; cursor: pointer; z-index: 1000;" onclick="installApp()">
                            üì± Install App
                        </div>
                    `;
                    document.body.appendChild(installBtn);
                }, 3000);
            }
        });
        
        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    deferredPrompt = null;
                });
            }
        }
        
        // Initialize
        updateProgress();
        updateGreeting();
        
        // Load saved language
        const savedLanguage = localStorage.getItem('rika-language') || 'en';
        document.getElementById('loginLanguageSelect').value = savedLanguage;
        updateLanguage(savedLanguage);
        
        // Trigger animations when dashboard is shown
        const originalShowScreen = showScreen;
        window.showScreen = function(screenId) {
            originalShowScreen(screenId);
            if (screenId === 'dashboard' && authToken) {
                setTimeout(initDashboardAnimations, 100);
                loadDashboardData();
            }
        };

        // ========================================
        // PWA Service Worker Registration
        // ========================================

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registered successfully:', registration.scope);

                        // Check for updates periodically
                        setInterval(() => {
                            registration.update();
                        }, 60000); // Check every minute

                        // Handle service worker updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;

                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New service worker available
                                    console.log('üîÑ New version available! Please refresh.');

                                    // Show update notification
                                    if (confirm('A new version of RIKA Care is available! Refresh to update?')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.warn('‚ö†Ô∏è Service Worker registration failed:', error);
                    });

                // Handle service worker controller change (after update)
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    console.log('üîÑ Service Worker updated, reloading page...');
                    window.location.reload();
                });
            });
        } else {
            console.warn('‚ö†Ô∏è Service Workers are not supported in this browser');
        }

        // PWA Install Prompt
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('üíæ PWA Install prompt available');

            // Prevent the default mini-infobar
            e.preventDefault();

            // Save the event for later
            deferredPrompt = e;

            // Show custom install button (if you want to add one)
            // You can add an "Install App" button in your UI and trigger it manually
        });

        // Track PWA installation
        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ PWA installed successfully!');
            deferredPrompt = null;

            // You can track this event with analytics
            // trackEvent('pwa_installed');
        });

        // Optional: Function to trigger install prompt manually
        window.promptPWAInstall = async () => {
            if (!deferredPrompt) {
                console.log('PWA install prompt not available');
                return false;
            }

            // Show the install prompt
            deferredPrompt.prompt();

            // Wait for the user's response
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User response to install prompt: ${outcome}`);

            // Clear the saved prompt since it can't be used again
            deferredPrompt = null;

            return outcome === 'accepted';
        };

        // Handle PWA launch (standalone mode detection)
        if (window.matchMedia('(display-mode: standalone)').matches ||
            window.navigator.standalone === true) {
            console.log('üöÄ Running as installed PWA');
            // You can add PWA-specific behavior here
            // For example, hide browser-specific UI elements
        }

        // Handle online/offline status
        window.addEventListener('online', () => {
            console.log('üåê Back online');
            // You can show a notification or update UI
        });

        window.addEventListener('offline', () => {
            console.log('üì° Gone offline');
            // You can show an offline indicator in your UI
        });
    </script>
</body>
</html>